/*! zybuluo */
function MediumEditor(a,b){"use strict";return this.init(a,b)}Namespace("com.zybuluo.mdeditor.common"),function(a){a.fn.setCursorPosition=function(b){if(a(this).get(0).setSelectionRange)a(this).get(0).setSelectionRange(b,b);else if(a(this).get(0).createTextRange){var c=a(this).get(0).createTextRange();c.collapse(!0),c.moveEnd("character",b),c.moveStart("character",b),c.select()}a(this).focus()},a.fn.tabHandler=function(){a(this).keydown(function(b){if(9===b.keyCode){var c=this.selectionStart,d=this.selectionEnd,e=a(this),f=e.val();e.val(f.substring(0,c)+"    "+f.substring(d)),this.selectionStart=this.selectionEnd=c+4,b.preventDefault()}})}}(jQuery);var fullScreenApi=function(){var a={supportsFullScreen:!1,isFullScreen:function(){return!1},requestFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",prefix:""},b="webkit moz o ms khtml".split(" ");if("undefined"!=typeof document.cancelFullScreen)a.supportsFullScreen=!0;else for(var c=0,d=b.length;d>c;c++)if(a.prefix=b[c],"undefined"!=typeof document[a.prefix+"CancelFullScreen"]){a.supportsFullScreen=!0;break}return a.supportsFullScreen&&(a.fullScreenEventName=a.prefix+"fullscreenchange",a.isFullScreen=function(){switch(this.prefix){case"":return document.fullScreen;case"webkit":return document.webkitIsFullScreen;default:return document[this.prefix+"FullScreen"]}},a.requestFullScreen=function(a){return"webkit"===this.prefix?a.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT):""===this.prefix?a.requestFullScreen():a[this.prefix+"RequestFullScreen"]()},a.cancelFullScreen=function(){return""===this.prefix?document.cancelFullScreen():document[this.prefix+"CancelFullScreen"]()}),"undefined"!=typeof jQuery&&(jQuery.fn.requestFullScreen=function(){return this.each(function(){a.supportsFullScreen&&a.requestFullScreen(this)})}),a}();com.zybuluo.mdeditor.common.getCurrentMode=function(){if(com.zybuluo.mdeditor.user_note)return null;var a=window.location.hash,b={isFullEditor:!1,isFullReader:!1,isEditorReader:!1,isHashMode:!1};return 0===a.indexOf("#full-editor")?b.isFullEditor=!0:0===a.indexOf("#full-reader")?b.isFullReader=!0:(a&&(b.isHashMode=!0),b.isEditorReader=!0),b},com.zybuluo.mdeditor.common.saveAs=function(a,b){if(void 0!==saveAs){var c=new Blob([a],{type:"text/plain;charset=utf-8"});saveAs(c,b)}else{var d="data:application/octet-stream;base64,"+utils.encodeBase64(a);window.open(d,"file")}},com.zybuluo.mdeditor.common.buttonBinding=function(a,b,c){$(a).each(function(){$(this).unbind("hover")}),$(a).animate({color:c},200),$(a).each(function(){$(this).hover(function(){$(this).animate({color:b},200)},function(){$(this).animate({color:c},200)})})},com.zybuluo.mdeditor.common.bindingFullScreenApi=function(a){fullScreenApi.supportsFullScreen?$(a).on("click",function(){fullScreenApi.isFullScreen()?fullScreenApi.cancelFullScreen():fullScreenApi.requestFullScreen(document.documentElement)}):$(a).on("click",function(){alert("您的浏览器不支持自动全屏，请尝试按 F11 切换全屏")})},com.zybuluo.mdeditor.common.colorWmdButtons=function(){var a=com.zybuluo.mdeditor.common.buttonBinding,b=com.zybuluo.mdeditor.common.getCurrentMode();b&&b.isFullEditor?$("body").hasClass("theme-white")?a(".wmd-button > span","#2C3E50","#999999"):a(".wmd-button > span","#F9F9F5","#BBBBBB"):a(".wmd-button > span","#F9F9F5","#BBBBBB")},com.zybuluo.mdeditor.common.applyPreviewElementTheme=function(a){var b=$("#prettify-style").attr("href");b=b.match(/.*\//)[0],null===a&&(a=$("body").hasClass("theme-black")?"theme-black":"theme-white");var c=com.zybuluo.mdeditor.common.buttonBinding;"theme-white"==a?($("#wmd-preview table").each(function(){$(this).removeClass().addClass("table table-striped-white table-bordered")}),$("code").each(function(){0===$(this).parents("pre.prettyprint").length&&$(this).removeClass("code-black")}),$("pre > code").each(function(){$(this).parent("pre").removeClass("code-black")}),$("#prettify-style").attr("href",b+"prettify-cmd.css"),c(".in-page-button > span","rgba(44, 62, 80, 0.65)","rgba(102, 128, 153, 0.45)"),$(".wmd-preview blockquote").removeClass().addClass("white-blockquote")):($("#wmd-preview table").each(function(){$(this).removeClass().addClass("table table-striped-black table-bordered")}),$("code").each(function(){0===$(this).parents("pre.prettyprint").length&&$(this).addClass("code-black")}),$("pre > code").each(function(){$(this).parent("pre").addClass("code-black")}),$("#prettify-style").attr("href",b+"desert-cmd.css"),c(".in-page-button > span","rgba(249, 249, 245, 0.65)","rgb(187, 187, 187, 0.45)"),$(".wmd-preview blockquote").removeClass().addClass("black-blockquote")),com.zybuluo.mdeditor.common.colorWmdButtons()},com.zybuluo.mdeditor.common.applySiteTheme=function(a){$(".theme").each(function(){$(this).removeClass("theme-white theme-black").addClass(a)});var b=com.zybuluo.mdeditor.common.applyPreviewElementTheme;b(a),$.localStorage("siteThemeClassName",a)},com.zybuluo.mdeditor.common.switchSiteTheme=function(a){var b=com.zybuluo.mdeditor.common.applySiteTheme;$("body").hasClass("theme-white")?(a&&a.applyTheme("theme-black"),b("theme-black")):(a&&a.applyTheme("theme-white"),b("theme-white"))},com.zybuluo.mdeditor.common.loadSiteTheme=function(a){var b=$.localStorage("siteThemeClassName");b||(b="theme-white"),a&&a.applyTheme(b);var c=com.zybuluo.mdeditor.common.applySiteTheme;c(b)},com.zybuluo.mdeditor.common.getCurrentThemeClassName=function(){var a=$.localStorage("siteThemeClassName");return a||(a="theme-white"),a},com.zybuluo.mdeditor.common.initiateToc=function(){$("#toc-list").on("click",function(a){a.stopPropagation()})}(),com.zybuluo.mdeditor.common.initialHiddenSideToolBar=function(){var a=com.zybuluo.mdeditor.common.buttonBinding;a(".preview-button-full-reader > span","#F9F9F5","#BBBBBB");var b=!1,c=function(){$("#reader-full-toolbar-tail").hasClass("reader-full-toolbar-tail-hidden")||(b?($("#reader-full-toolbar").show(),$("#preview-hidden-button span").attr("title","隐藏工具栏 Ctrl+Alt+I").removeClass("icon-chevron-sign-left").addClass("icon-chevron-sign-right"),a("#preview-hidden-button span","#F9F9F5","#BBBBBB"),b=!1):($("#reader-full-toolbar").hide(),$("#preview-hidden-button span").attr("title","显示工具栏 Ctrl+Alt+I").removeClass("icon-chevron-sign-right").addClass("icon-chevron-sign-left"),a("#preview-hidden-button span","#BBBBBB","#BBBBBB"),b=!0))};$("#preview-hidden-button").on("click",c);var d=function(){var a=com.zybuluo.common.getCurrentScreenType,b=a();b.isMobile&&c()};return{hideToolBar:c,hideToolBarForMobile:d,isHidden:function(){return b}}}(),com.zybuluo.mdeditor.common.resetMaxHeightOfFileList=function(){var a=$("#preview-list-button");if(0!==a.length){var b=$(window).height()-a.position().top-100;$("ul.dropdown-menu#file-list").css("max-height",b)}},com.zybuluo.mdeditor.common.caculatePreviewCharacters=function(){var a=$("#wmd-preview").text();return(a.match(/\S/g)||[]).length},com.zybuluo.mdeditor.common.caculateAndFillPreviewCharacters=function(){var a=com.zybuluo.mdeditor.common.caculatePreviewCharacters(),b=$(".article-characters");0!==b.length&&b.each(function(){$(this).text(a)})},com.zybuluo.mdeditor.common.generateUUID=function(a){var b=0,c="";for(b=0;a>b;b++)c+="0123456789abcdefghijklmnopqrstuvwxyz"[Math.floor(36*Math.random())];return c},com.zybuluo.mdeditor.common.wmdPreviewChildNodes_callback=function(a){var b=document.getElementById("wmd-preview").childNodes,c=0,d=0;for(d in b)if(b[d]&&1===b[d].nodeType){var e=b[d].innerHTML;""!==e&&(a(b[d]),c++)}return c},com.zybuluo.mdeditor.common.initiateSearchFileComponent=function(){$("#file-list-topbar").on("click",function(a){a.stopPropagation(),$("#search-file-textbox").focus()});var a=0,b=0,c=function(){var c=$("#file-list .tag-item");c.show(),c.siblings().hide(),c.data("hidden",!0);var d=$("#file-list .whiter-on-black").first().parent("a").parent("li"),e=d.siblings(".tag-item");e.siblings().show(),e.data("hidden",!1),d.addClass("selected-item");var f=d.prevAll().length,g=e.index(".tag-item");b=d.height(),a=e.height();var h=$("#file-list"),i=f*b+(g+1)*a-h.height();h.scrollTop(i)},d=function(a,b){b.stopPropagation(),a.data("hidden")===!0?(a.siblings().show(),a.data("hidden",!1)):(a.siblings().hide(),a.data("hidden",!0))};$("#file-list").on("click",".tag-item",function(a){d($(this),a)});var e=null,f=function(){e={},$("#file-list .file-item").each(function(){var a=$(this).find("span"),b=a.attr("id"),c=a.text();b in e||(e[b]=[c,$(this)])})},g=_.debounce(function(){$("#file-list .selected-item").removeClass("selected-item");var a=$(this).val();if(""===a)c();else{$("#file-list .tag-item").hide(),$("#file-list .file-item:visible").hide();for(var b in e)-1!==e[b][0].toLowerCase().indexOf(a.toLowerCase())||"*"===a?e[b][1].show():e[b][1].hide();$("#file-list").scrollTop(0),$("#file-list .file-item:visible").first().addClass("selected-item")}},100);$("#search-file-textbox").on("input",g);var h=function(c,d){var e=$("#file-list .selected-item");if(0!==e.length){var f=$("#file-list .item:visible");e.removeClass("selected-item");var g=null;c===!0?(g=e.index(".item:visible")+1,g>=f.length&&(g=0)):(g=e.index(".item:visible")-1,0>g&&(g=$(".item:visible").length-1));var h=$(f[g]);h.addClass("selected-item");var i=0,j=0;f.each(function(){return $(this).hasClass("file-item")===!0?j+=1:$(this).hasClass("tag-item")===!0&&(i+=1),j+i===g+1?!1:void 0});var k=$("#file-list"),l=j*b+i*a-k.height();k.scrollTop(l),d.stopPropagation()}};$("#search-file-textbox").on("keydown",function(a){var b=a.charCode||a.keyCode;switch(b){case 13:var c=$("#file-list .selected-item");if(c.hasClass("file-item")){var e=c.find("a").attr("href");if(e){if(e+window.location.hash===window.location.href){$("#preview-list-button > span").dropdown("toggle");break}var f=com.zybuluo.mdeditor.common.getCurrentMode();window.location=f&&f.isEditorReader?e:e+window.location.hash}}else c.hasClass("tag-item")&&d(c,a);break;case 27:$("#preview-list-button > span").dropdown("toggle");break;case 40:h(!0,a);break;case 38:h(!1,a)}}),$("#preview-list-button").on("show",function(){$("#search-file-bar").css("display","block"),$("#tag-file-bar").css("display","none"),$("#search-file-textbox").val(""),c(),$("#search-file-textbox").focus(),f()}).on("hide",function(){e=null,$("#file-list .selected-item").removeClass("selected-item")})}(),"object"==typeof module&&(module.exports=MediumEditor),function(a,b){"use strict";function c(a,b){var c;if(void 0===a)return b;for(c in b)b.hasOwnProperty(c)&&a.hasOwnProperty(c)===!1&&(a[c]=b[c]);return a}function d(){var c,d,e,f,g="";if(void 0!==a.getSelection){if(d=a.getSelection(),d.rangeCount){for(f=b.createElement("div"),c=0,e=d.rangeCount;e>c;c+=1)f.appendChild(d.getRangeAt(c).cloneContents());g=f.innerHTML}}else void 0!==b.selection&&"Text"===b.selection.type&&(g=b.selection.createRange().htmlText);return g}function e(){var c="";return a.getSelection?c=a.getSelection().toString():b.selection&&"Control"!=b.selection.type&&(c=b.selection.createRange().text),c}function f(a){return!(!a||1!==a.nodeType)}MediumEditor.prototype={defaults:{buttons:["remark","highlight"],delay:0,diffLeft:0,diffTop:-10,disableToolbar:!1,elementsContainer:!1,extensions:{},firstButtonClass:"medium-editor-button-first",lastButtonClass:"medium-editor-button-last"},isIE:"Microsoft Internet Explorer"===navigator.appName||"Netscape"===navigator.appName&&null!==new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent),init:function(a,d){return this.elementSelection=a,this.id=b.querySelectorAll(".medium-editor-toolbar").length+1,this.options=c(d,this.defaults),this.setup()},setup:function(){this.isActive=!0,this.initElements().bindSelect().bindWindowActions()},initElements:function(){this.elements="string"==typeof this.elementSelection?b.querySelectorAll(this.elementSelection):this.elementSelection;var a;for(a=0;a<this.elements.length;a+=1)this.elements[a].setAttribute("data-medium-element",!0);return this.options.elementsContainer||(this.options.elementsContainer=b.body),this.initToolbar().bindButtons(),this},buttonTemplate:function(a){var b={remark:'<button data-action="remark"><i class="icon-comment"></i></button>',highlight:'<button data-action="highlight"><i class="icon-pencil"></i></button>'};return b[a]||!1},initToolbar:function(){return this.toolbar?this:(this.toolbar=this.createToolbar(),this.keepToolbarAlive=!1,this.toolbarActions=this.toolbar.querySelector(".medium-editor-toolbar-actions"),this)},createToolbar:function(){var a=b.createElement("div");return a.id="medium-editor-toolbar-"+this.id,a.className="medium-editor-toolbar",a.appendChild(this.toolbarButtons()),this.options.elementsContainer.appendChild(a),a},toolbarButtons:function(){var a,c,d,e,g=this.options.buttons,h=b.createElement("ul");for(h.id="medium-editor-toolbar-actions",h.className="medium-editor-toolbar-actions clearfix",c=0;c<g.length;c+=1)this.options.extensions.hasOwnProperty(g[c])?(e=this.options.extensions[g[c]],d=void 0!==e.getButton?e.getButton():null):d=this.buttonTemplate(g[c]),d&&(a=b.createElement("li"),f(d)?a.appendChild(d):a.innerHTML=d,h.appendChild(a));return h},bindSelect:function(){var a=this,c="";return this.checkSelectionWrapper=function(){clearTimeout(c),c=setTimeout(function(){a.checkSelection()},a.options.delay)},b.documentElement.addEventListener("mouseup",this.checkSelectionWrapper),this},checkSelection:function(){var b,c=this.getMediumElementForShowingToolBar();if(null===c||c===!1||this.getSideRemark().isPopulatedNoteRemarks()===!1)return this.hideToolbarActions(),this;if(this.keepToolbarAlive!==!0&&!this.options.disableToolbar)if(b=a.getSelection(),""!==b.toString().trim()&&this.isToolbarShowableForSelection()){var d=b.getRangeAt(0);if(d&&!b.isCollapsed){var e=this.getTopLevelMediumElement(d.commonAncestorContainer),f=e.getAttribute("data-anchor-id");f?this.checkSelectionElement(b):this.hideToolbarActions()}else this.hideToolbarActions()}else this.hideToolbarActions();return this},isToolbarShowableForSelection:function(){var a=d().replace(/<[\S]+><\/[\S]+>/gim,""),b=a.match(/(<[\s\S]+?>|<\/[\s\S]+?>)/g);if(b=b?b.length:0,0===b)return!0;var c=a.match(/(<(strong|em|code|a|del|span|i|br)?>|<(strong|em|code|a|del|span|i|br)(\s+?|\s+[\s\S]+?)>|<\/(strong|em|code|a|del|span|i|br)?>)/g);return c=c?c.length:0,b===c?!0:!1},checkSelectionElement:function(a){this.selection=a,this.selectionRange=this.selection.getRangeAt(0),this.setToolbarPosition().showToolbarActions()},toolbarShownForMediumElements:["blockquote","pre","p","h1","h2","h3","h4","h5","h6","ul","ol","li","strong","em","code","a","del","span","i","br"],getMediumElementForShowingToolBar:function(){var b,c,d,e,f=a.getSelection(),g=this.toolbarShownForMediumElements,h=function(a){var b=!0,c=a;try{for(;!c.getAttribute("data-medium-element");)b===!0&&-1===g.indexOf(c.tagName.toLowerCase())&&(b=!1),c=c.parentNode}catch(d){return null}return b};try{if(b=f.getRangeAt(0),c=b.commonAncestorContainer,d=c.parentNode,c.getAttribute("data-medium-element"))return!1;e=h(d)}catch(i){e=h(d)}return e},setToolbarPosition:function(){var b=50,c=a.getSelection(),d=c.getRangeAt(0),e=d.getBoundingClientRect(),f=this.options.diffLeft-this.toolbar.offsetWidth/2,g=(e.left+e.right)/2,h=this.toolbar.offsetWidth/2;return e.top<b?(this.toolbar.classList.add("medium-toolbar-arrow-over"),this.toolbar.classList.remove("medium-toolbar-arrow-under"),this.toolbar.style.top=b+e.bottom-this.options.diffTop+a.pageYOffset-this.toolbar.offsetHeight+"px"):(this.toolbar.classList.add("medium-toolbar-arrow-under"),this.toolbar.classList.remove("medium-toolbar-arrow-over"),this.toolbar.style.top=e.top+this.options.diffTop+a.pageYOffset-this.toolbar.offsetHeight+"px"),this.toolbar.style.left=h>g?f+h+"px":a.innerWidth-g<h?a.innerWidth+f-h+"px":f+g+"px",this},bindButtons:function(){var a,b=this.toolbar.querySelectorAll("button"),c=this,d=function(a){a.preventDefault(),a.stopPropagation(),void 0===c.selection&&c.checkSelection(),this.hasAttribute("data-action")&&c.execAction(this.getAttribute("data-action"),a)};for(a=0;a<b.length;a+=1)b[a].addEventListener("click",d);return this.setFirstAndLastItems(b),this},setFirstAndLastItems:function(a){return a.length>0&&(a[0].className+=" "+this.options.firstButtonClass,a[a.length-1].className+=" "+this.options.lastButtonClass),this},deselectText:function(){var c=e();if(""!==c){var d=this.getMediumElementForShowingToolBar();null!==d&&(a.getSelection?a.getSelection().empty?a.getSelection().empty():a.getSelection().removeAllRanges&&a.getSelection().removeAllRanges():b.selection&&b.selection.empty())}},getTopLevelMediumElement:function(a){try{a.getAttribute("data-medium-element")}catch(b){a=a.parentNode}var c=null;try{for(;!a.getAttribute("data-medium-element");)c=a,a=a.parentNode}catch(d){return null}return c},highlight:function(a,c,d){this.removeHighlight(),this.backupTopLevelMediumElement=a.innerHTML;var e=b.createRange(),f=0,g=!1,h=!1,i=function(a){for(var b in a.childNodes){var j=a.childNodes[b];if(j=3===j.nodeType?j:i(j),null!==j&&void 0!==j&&0!==j.textContent.length){if(h===!0)return;if(g===!1){if(j.textContent.length-1+f>=c&&(e.setStart(j,c-f),g=!0,j.textContent.length+f>=d))return e.setEnd(j,d-f),void(h=!0)}else if(j.textContent.length+f>=d)return e.setEnd(j,d-f),void(h=!0);f+=j.textContent.length}}};i(a);var j=b.createElement("div");j.appendChild(e.extractContents()),j.innerHTML='<span class="highlight-blue">'+j.innerHTML+"</span>",e.insertNode(j.firstChild)},highlightSelection:function(){var c;a.getSelection?c=a.getSelection():"undefined"!=typeof b.selection&&(c=b.selection);var d=c.getRangeAt(0);if(d&&!c.isCollapsed){var f=e(),g=this.getTopLevelMediumElement(d.commonAncestorContainer),h=g.getAttribute("data-anchor-id");if(!h)return null;for(var i=d.startOffset,j=d.startContainer;j!==g;)null!==j.previousSibling?(j=j.previousSibling,i+=j.textContent.length):j=j.parentNode;var k=f.length,l=i+k;return this.getSideRemark().hideSideRemark(),this.highlight(g,i,l),{anchorId:h,highlightContent:f,highlightStart:i,highlightEnd:l}}return null},backupTopLevelMediumElement:null,removeHighlight:function(){var a=b.getElementsByClassName("highlight-blue");if(a.length>0&&null!==this.backupTopLevelMediumElement){var c=this.getTopLevelMediumElement(a[0]);c.innerHTML=this.backupTopLevelMediumElement}this.backupTopLevelMediumElement=null},highlightInfo:null,getSideRemark:function(){return com.zybuluo.mdeditor.sideRemark},execAction:function(a){this.highlightInfo=this.highlightSelection(),this.highlightInfo&&("remark"===a?this.getSideRemark().showSideRemarkByHighlight(this.highlightInfo.anchorId,!0):"highlight"===a&&this.getSideRemark().showSideRemarkByHighlight(this.highlightInfo.anchorId,!1)),this.deselectTextAndHideToolbar()},deselectTextAndHideToolbar:function(){this.deselectText(),this.hideToolbarActions()},hideToolbarActions:function(){this.keepToolbarAlive=!1,void 0!==this.toolbar&&(this.toolbar.classList.remove("medium-editor-toolbar-active"),this.toolbar.classList.remove("medium-toolbar-arrow-under"),this.toolbar.classList.remove("medium-toolbar-arrow-over"),this.toolbar.removeAttribute("style"),this.toolbarActions.removeAttribute("style"))},showToolbarActions:function(){var a,b=this;this.toolbarActions.style.display="block",this.keepToolbarAlive=!1,clearTimeout(a),a=setTimeout(function(){b.toolbar&&!b.toolbar.classList.contains("medium-editor-toolbar-active")&&b.toolbar.classList.add("medium-editor-toolbar-active")},100)},bindWindowActions:function(){var b,c=this;return this.windowResizeHandler=function(){clearTimeout(b),b=setTimeout(function(){c.toolbar&&c.toolbar.classList.contains("medium-editor-toolbar-active")&&c.setToolbarPosition()},100)},a.addEventListener("resize",this.windowResizeHandler),this}}}(window,document),com.zybuluo.mdeditor.mediumEditor=function(){return new MediumEditor(".wmd-preview",{})}(),com.zybuluo.mdeditor.sideRemark=function(){var a=com.zybuluo.mdeditor.common.getCurrentMode,b=com.zybuluo.mdeditor.mediumEditor,c=com.zybuluo.mdeditor.layout.initData,d={remarkIconTopGutter:-5,remarkIconRightGutter:10,remarkIconRightAdditionalGutter:25,remarkLeftGutter:55,remarkRightGutter:50,maxRemarkContentLength:400,maxRemarkReplyContentLength:200},e=null,f=null,g=$(window),h=$("#wmd-preview"),i=$("#wmd-panel-preview"),j=$(".remark-list"),k=j.children(".remark-items"),l=$(".new-remark-reply.side-remark-hidden"),m=l.clone().removeClass("side-remark-hidden").html(),n=j.children(".new-remark").prepend(m);n.children(".remark-head").find("img").css("width","32px").css("height","32px");var o=n.children(".remark-editor"),p=j.children(".leave-remark"),q=$(".remark-item.side-remark-hidden"),r=$(".remark-icons"),s=$(".remark-icon.side-remark-hidden"),t=$(".remark-item-reply.side-remark-hidden"),u=function(a,b){var c=a.find("span#default-span");0!==c.length&&c.remove(),b.preventDefault();var d=null;if(b.clipboardData){if(d=(b.originalEvent||b).clipboardData.getData("text/plain"),d=d.replace(/(\n|\r)/gim,"").replace(/\s+/gim," ").trim(),""===d)return!1;document.execCommand("insertText",!1,d)}else if(window.clipboardData){if(d=window.clipboardData.getData("Text"),d=d.replace(/(\n|\r)/gim,"").replace(/\s+/gim," ").trim(),""===d)return!1;document.selection.createRange().pasteHTML(d)}},v=function(a,b,d){a.attr("data-rand-id",b.rand_id).attr("data-version-id",b.version_id),d?a.children(".remark-head").find("img").css("width","32px").css("height","32px"):a.children(".remark-head").find("img").css("width","24px").css("height","24px"),a.children(".remark-author").html("<strong>"+b.username+"</strong>");var e=a.children(".remark-editor");e.removeAttr("contentEditable").text(b.content),e.get(0).addEventListener("paste",function(a){return u(e,a)});var f=a.children(".remark-footer");c.loggedInUsername===b.username?(f.children(".remark-save").hide(),f.children(".remark-cancel").hide(),f.children(".remark-delete").hide()):f.hide()},w=function(a){var b=q.clone().removeClass("side-remark-hidden"),d=b.children(".remark-options"),e=d.children(".remark-private").remove(),f=d.children(".remark-public").remove(),g=d.children(".remark-delete").remove(),h=b.children(".remark-published-link").hide();c.isPageOwner===!0?(a.public===!0?(d.append(f.show()),d.append(e.hide()),h.show(),h.css("right","95px"),h.tooltip({title:"点击更新地址栏以获取可分享此批注的链接",placement:"top"})):(d.append(e.show()),d.append(f.hide())),d.append(g.hide())):a.public===!0?(d.hide(),h.show(),h.tooltip({title:"点击更新地址栏以获取可分享此批注的链接",placement:"top"})):(d.append(e.show()),e.tooltip({title:"此批注目前仅对批注者和作者可见，作者可以公开此批注使所有人可见。",placement:"top"})),d.children("li").length>1&&d.children("li:first").append('<span class="icon-chevron-down"></span>');var i=t.clone().removeClass("side-remark-hidden");i.children(".remark-delete-link").remove(),d.after(i.html()),v(b,a,!0);var j=a.username,k=b.children(".remark-reply-view-more").hide(),l=a.userNoteRemarkReplyUIs,m=l.length;for(var n in l){var o=l[n],p=t.clone().removeClass("side-remark-hidden remark-item-reply").addClass("remark-reply");c.isPageOwner||c.loggedInUsername===j?c.loggedInUsername===o.username?p.children(".remark-delete-link").remove():p.children(".remark-delete-link").tooltip({title:"删除这条回复",placement:"top"}).hide():p.children(".remark-delete-link").remove(),v(p,o,!1),m>3&&m-3>n&&p.hide(),b.children(".remark-replies").append(p)}return m>3&&(k.text("展开较早的 "+(m-3)+" 条回复"),k.show()),b.children(".leave-reply").show(),b.children(".new-reply").hide(),b},x=function(){var a=null,b=document.getElementsByClassName("highlight-blue");if(b.length>0)a=$(b[0]).position().top;else{var c=r.children(".remark-icon-clicked");if(0===c.length)return;a=c.position().top}g.scrollTop()>a?g.scrollTop(a-100):(a-=g.height(),g.scrollTop()<a+100&&g.scrollTop(a+g.height()/2))},y=function(a,c,e){var f=null,i=null,l=null,m=null,o=null,q=null;if(j.hasClass("side-remark-hidden"))return null;e!==!0&&x();var s=document.getElementsByClassName("highlight-blue");if(s.length>0){f=s[0].getBoundingClientRect().top;var t=b.getTopLevelMediumElement(s[0]);i=t.getBoundingClientRect().right,l=t.getAttribute("data-anchor-id"),m=f+(document.documentElement.scrollTop||document.body.scrollTop)}else{var u=r.children(".remark-icon-clicked");if(0===u.length)return null;f=u.position().top-d.remarkIconTopGutter,i=u.position().left-d.remarkIconRightGutter,l=u.attr("data-anchor-id"),m=f}o=i+d.remarkLeftGutter,q=i+d.remarkIconRightGutter;var v=o+j.width()+d.remarkRightGutter,w=parseFloat(h.css("left"));if(w=isNaN(w)?0:-1*w,v+w>g.width()){var y=v-g.width();h.animate({left:"-="+y},100),Q(q-y),o-=y}else h.animate({left:"0px"},100),Q(q+w),o+=w;if(a===!0)m-=n.is(":visible")?j.height()-n.height():j.height()-p.height();else if(void 0!==c&&c>0){for(var z=0,A=k.children(".remark-item"),B=0;c>B;B++){var C=$(A[B]);z=z+parseInt(C.css("padding-top"),10)+C.height()+parseInt(C.css("padding-bottom"),10)}m-=z}return cb=!0,j.animate({left:o+"px"},0),j.animate({top:m+"px"},100,function(){cb=!1}),l},z=function(){var a=null,c=document.getElementsByClassName("highlight-blue");if(c.length>0){var d=b.getTopLevelMediumElement(c[0]);a=d.getAttribute("data-anchor-id")}else{var e=r.children(".remark-icon-clicked");if(0===e.length)return null;a=e.attr("data-anchor-id")}return a},A=function(a,c){var d=e[a];if(d&&d.length>c){var g=d[c],h=g.highlight_content,i=g.highlight_start,j=g.highlight_end;if(null!==h&&null!==i){var k=f[a],l=k.textContent.indexOf(h,i);if(l===i)return void b.highlight(k,i,j)}b.removeHighlight()}},B=function(a,b,c){var d=z();if(null!==e&&d){var f=e[d];for(var g in f){var h=f[g],i=w(h);k.append(i)}}a===!0?(p.hide(),n.show()):(p.show(),n.hide());var l=n.children(".remark-footer").children(".remark-save");b?l.addClass("highlight-save"):l.removeClass("highlight-save"),x(),j.removeClass("side-remark-hidden").addClass("side-remark-shown"),y(b,0),a===!0&&(b===!0&&c===!1?(o.text("高亮批注"),setTimeout(function(){G(o)},200)):H(n))},C=function(){b.highlightInfo=null,o.text(""),o.next(".inline-error").remove(),k.html("");var a=r.children(".remark-icon-clicked").removeClass("remark-icon-clicked");a.removeClass("remark-icon-hover"),a.hasClass("remark-icon-empty")&&a.hide()},D=function(){var b=a();null===b?window.location.hash.match(/([0-9a-z]{4})-([0-9a-z]{12})/)&&window.history.pushState&&window.history.pushState(null,"",window.location.pathname):b.isFullReader&&window.location.hash.match(/full-reader-([0-9a-z]{4})-([0-9a-z]{12})/)&&(window.location.hash="#full-reader")},E=function(){D();var a=r.children(".remark-icon-clicked");if(0!==a.length){var b=parseFloat(h.css("left"));b=isNaN(b)?0:-1*b,Q(a.position().left+b)}h.animate({left:"0px"},100),C(),j.removeClass("side-remark-shown").addClass("side-remark-hidden")},F=function(a,b,c){var d=a,e=document.createRange(),f=window.getSelection();e.setStart(d.childNodes[b],c),e.collapse(!0),f.removeAllRanges(),f.addRange(e),setTimeout(function(){d.focus()},200)},G=function(a){a.text(a.text()),a.focus();var b,c,d=a.get(0);document.createRange?(b=document.createRange(),b.selectNodeContents(d),b.collapse(!1),c=window.getSelection(),c.removeAllRanges(),c.addRange(b)):document.selection&&(b=document.body.createTextRange(),b.moveToElementText(d),b.collapse(!1),b.select())},H=function(a){var b=a.children(".remark-editor");return""===b.text().trim()?(b.html(a.hasClass("new-reply")?'<p><span id="default-span">在此处回复批注</span><br></p>':'<p><span id="default-span">在此处批注</span><br></p>'),F(b.get(0),0,0),!0):!1},I=com.zybuluo.mdeditor.common.wmdPreviewChildNodes_callback,J=null,K=null,L=function(){null!==K&&K.hasClass("remark-icon-clicked")===!1&&(clearTimeout(J),K.hide(),K=null)},M=function(a){null!==K&&K.hasClass("remark-icon-clicked")===!1&&(clearTimeout(J),K.hide()),K=a,a.show()},N=function(a){a.hasClass("remark-icon-clicked")===!1&&(clearTimeout(J),J=setTimeout(function(){a.hide(),K=null},1e3))},O=function(a,b,c){var d=$(a);d.off("mouseenter.bind"),d.off("mouseleave.bind"),b.off("mouseenter.bind"),b.off("mouseleave.bind"),c&&c.length>0?(b.find(".remark-count").text(c.length),b.removeClass("remark-icon-empty"),d.on("mouseenter.bind",function(){L()}).on("mouseleave.bind",function(){}),b.on("mouseenter.bind",function(){L()}).on("mouseleave.bind",function(){})):(b.find(".remark-count").text("+"),b.addClass("remark-icon-empty"),d.on("mouseenter.bind",function(){M(b)}).on("mouseleave.bind",function(){N(b)}),b.on("mouseenter.bind",function(){M(b)}).on("mouseleave.bind",function(){N(b)}))},P=function(a){var b=a.getBoundingClientRect().top,c=0,e=0;"relative"===r.parent().css("position")?(c=h.width()+d.remarkIconRightAdditionalGutter,e=b+(document.documentElement.scrollTop||document.body.scrollTop)+d.remarkIconTopGutter-i.position().top+i.scrollTop()):(c=a.getBoundingClientRect().right,e=b+(document.documentElement.scrollTop||document.body.scrollTop)+d.remarkIconTopGutter);var f=c+d.remarkIconRightGutter;return{top:e,left:f}},Q=function(a){var b=r.children(".remark-icon");if(0!==b.length){if(void 0===a){var c=0;I(function(a){var d=a.getAttribute("data-anchor-id");if(null!==d){var e=P(a);$(b[c++]).attr("style","top:"+e.top+"px;left:"+e.left+"px;")}})}else for(var d in b)$(b[d++]).css("left",a);r.find(".remark-icon-empty").hide(),r.children(".remark-icon-clicked").show()}},R=function(){return null!==e?!0:!1},S=function(){r.html("");var b=function(){var b=a(),c=null,d=null,g=null,h=null;null===b?c=window.location.hash.match(/([0-9a-z]{4})-([0-9a-z]{12})(-reply)?/):b.isFullReader&&(c=window.location.hash.match(/full-reader-([0-9a-z]{4})-([0-9a-z]{12})(-reply)?/)),c&&(d=c[1],g=c[2],h=c[3]);var i=null;if(f={},I(function(a){var c=a.getAttribute("data-anchor-id");if(null!==c){var g=P(a),h=s.clone().removeClass("side-remark-hidden").attr("style","top:"+g.top+"px;left:"+g.left+"px;");if(null!==e){var j=e[c];O(a,h,j)}h.attr("data-anchor-id",c),r.append(h),f[c]=a,c===d&&(i=h)}else if(null===b){var k=$(a);if(k.hasClass("MathJax_Display")){var l=k.prev();if(0===k.next().attr("id").indexOf("MathJax-Element")){var m=k.next();l.append(k),l.append(m)}else l.append(k)}}}),r.find(".remark-icon-empty").hide(),i&&!i.hasClass("remark-icon-empty")){L(),i.trigger("click");var j=k.children(".remark-item"),l=null;j.each(function(){var a=$(this);return g===a.attr("data-rand-id")?(l=a,!1):void 0}),l&&setTimeout(function(){l.trigger("mouseenter"),l.trigger("mouseup"),h&&l.find(".leave-reply span").trigger("click")},300)}};null===e?$.get(c.noteRemarksUrl,{},function(a){a.anchorUserNoteRemarkUIsMap?(e=JSON.parse(a.anchorUserNoteRemarkUIsMap),b()):a.error},"json").fail(function(){}):b()},T=function(a,b){a.next(".inline-error").remove();var c=a.text().trim().length;c>b&&a.after('<div class="inline-error">'+c+"/"+b+"</div>")};$(".remark-list").on("mousedown",".remark-editor",function(a){if(0!==$(this).find("span#default-span").length&&window.getSelection().rangeCount>0){var b=window.getSelection().getRangeAt(0);if(b&&b.commonAncestorContainer){var c=b.commonAncestorContainer.firstChild;if(c&&"function"==typeof c.getAttribute&&"default-span"===c.getAttribute("id"))return void a.preventDefault()}F($(this).get(0),0,0),a.preventDefault()}});var U=com.zybuluo.common.popupConfirm,V=function(a){if(j.hasClass("side-remark-shown")){var b=function(b){U("提醒","您有未保存的批注信息，是否确认放弃？",function(){$("#notification").modal("hide"),a()},function(){G(b)})},c=!1;if($(".remark-item>.remark-editor[contentEditable='true'], .remark-reply>.remark-editor[contentEditable='true']").each(function(){var a=$(this),d=a.parent(".remark-item"),e=Y(d),f=e.userNoteRemarkUI,g=a.parent(".remark-reply");if(0===g.length){if(a.text()!==f.content)return b(a),c=!0,!1}else{var h=g.prevAll().length;if(a.text()!==f.userNoteRemarkReplyUIs[h].content)return b(a),c=!0,!1}}),c)return;$(".new-reply>.remark-editor[contentEditable='true'], .new-remark>.remark-editor[contentEditable='true']").each(function(){var d=$(this),e=d.find("span#default-span");return 0===e.length&&d.text().trim().length>0&&(0!==d.parent(".new-reply").length||"高亮批注"!==d.text())?(b(d),c=!0,!1):void a()})}else a()};$("body").on("mouseup",function(){V(function(){b.removeHighlight(),E()
})}),j.on("mouseup",function(){return!1}),r.on("mouseup",".remark-icon",function(){return!1}),$("#notification").on("mouseup",function(){return!1}),$("#preview-reader-small-button").on("mouseup",function(){return!1});var W=com.zybuluo.common.browserType;W.isOpera||W.isFirefox?($(".remark-list").on("input",".remark-editor[contentEditable='true']",function(){var a=$(this).find("span#default-span");0!==a.length&&a.remove();var b=$(this);b.parent(".new-reply").length>0||b.parent(".remark-reply").length>0?T(b,d.maxRemarkReplyContentLength):T(b,d.maxRemarkContentLength)}),$(".remark-list").on("keypress",".remark-editor[contentEditable='true']",function(a){var b=a.charCode||a.keyCode;return 13===b?($(this).next(".remark-footer").children(".remark-save").trigger("click"),!1):void 0})):($(".remark-list").on("keydown",".remark-editor[contentEditable='true']",function(a){var b=a.charCode||a.keyCode;if(13===b)return $(this).next(".remark-footer").children(".remark-save").trigger("click"),!1;var c=$(this).find("span#default-span");0!==c.length&&c.remove()}),$(".remark-list").on("keyup",".remark-editor[contentEditable='true']",function(){var a=$(this);a.parent(".new-reply").length>0||a.parent(".remark-reply").length>0?T(a,d.maxRemarkReplyContentLength):T(a,d.maxRemarkContentLength)})),o.get(0).addEventListener("paste",function(a){return u(o,a)});var X=function(a,b,c){var d=a.find("span#default-span");if(0!==d.length)return c.trigger("click"),null;var e=a.text().trim(),f=e.length;return f>b?null:0===f?(c.trigger("click"),null):e};k.on("click",".remark-edit",function(){var a=$(this).parent(".remark-footer"),b=a.siblings(".remark-editor");b.attr("contentEditable","true"),a.children().show(),$(this).hide(),setTimeout(function(){G(b)},200)});var Y=function(a){var b=z(),c=f[b],d=e[b],g=a.prevAll().length,h=d[g];return{anchorId:b,wmdPreviewChildNode:c,userNoteRemarkUIs:d,indexOfRemarkItem:g,userNoteRemarkUI:h}};k.on("click",".remark-item > .remark-footer > .remark-cancel, .remark-reply > .remark-footer > .remark-cancel",function(){var a=$(this).parents(".remark-item"),b=Y(a),c=b.userNoteRemarkUI,d=$(this).parent(".remark-footer"),e=d.siblings(".remark-editor"),f=d.parent(".remark-reply");if(f.length>0){var g=f.prevAll().length;e.removeAttr("contentEditable").text(c.userNoteRemarkReplyUIs[g].content)}else e.removeAttr("contentEditable").text(c.content);e.next(".inline-error").remove(),d.children().hide(),d.children(".remark-edit").show()});var Z=function(a){var b="【"+a+"】需要用户登录，现在登录？";return c.loggedInUsername?!0:(U(a,b,function(){window.location=c.loginComeFromUrl}),!1)},_=function(a){var d="确认删除这条批注吗？";window.confirm(d)&&(Pace.restart(),$.post(c.deleteNoteRemarkUrl,{remark_rand_id:a.attr("data-rand-id"),version_id:a.attr("data-version-id")},function(d){if(d.loggedin===!1)window.location=c.loginComeFromUrl;else if(d.success===!0){var e=Y(a),f=e.userNoteRemarkUIs,g=e.indexOfRemarkItem;f.splice(g,1),a.remove(),b.removeHighlight();var h=r.children(".remark-icon-clicked"),i=e.wmdPreviewChildNode;1===h.length&&i&&O(i,h,f)}else d.version_error===!0?U("删除批注",'批注已在别处被更新，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试'):d.error&&U("删除批注",'出错啦，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试')},"json").fail(function(){U("删除批注",'出错啦，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试')}))};k.on("click",".remark-item > .remark-footer > .remark-delete",function(){var a=$(this).parents(".remark-item");_(a)}),k.on("click",".remark-item > .remark-options > .remark-delete",function(){var a=$(this).parents(".remark-item");_(a)});var ab=function(a,b){var d="确认删除这条批注回复吗？";window.confirm(d)&&(Pace.restart(),$.post(c.deleteNoteRemarkReplyUrl,{remark_rand_id:a.attr("data-rand-id"),remark_reply_rand_id:b.attr("data-rand-id"),version_id:b.attr("data-version-id")},function(d){if(d.loggedin===!1)window.location=c.loginComeFromUrl;else if(d.success===!0){var e=Y(a),f=e.userNoteRemarkUI;f.userNoteRemarkReplyUIs.splice(b.prevAll().length,1),b.remove();var g=a.children(".remark-reply-view-more"),h=g.siblings(".remark-replies"),i=h.children(".remark-reply"),j=i.length;j===h.children(".remark-reply:visible").length?j>3?g.text("收起较早的 "+(j-3)+" 条回复"):g.hide():j>=3&&($(i[j-3]).show(),j-3>0?g.text("展开较早的 "+(j-3)+" 条回复"):g.hide())}else d.version_error===!0?U("删除批注回复",'批注回复已在别处被更新，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试'):d.error&&U("删除批注回复",'出错啦，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试')},"json").fail(function(){U("删除批注回复",'出错啦，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试')}))};k.on("click",".remark-reply > .remark-footer > .remark-delete",function(){var a=$(this),b=a.parents(".remark-item"),c=a.parent(".remark-footer").parent(".remark-reply");ab(b,c)}),k.on("click",".remark-reply > .remark-delete-link",function(){var a=$(this),b=a.parents(".remark-item"),c=a.parent(".remark-reply");ab(b,c)}),k.on("click",".remark-item > .remark-footer > .remark-save",function(){var a=$(this).parent(".remark-footer").siblings(".remark-editor"),b=$(this).siblings(".remark-delete"),e=X(a,d.maxRemarkContentLength,b);if(null!==e){var f=$(this).parents(".remark-item"),g=Y(f),h=g.userNoteRemarkUI;Pace.restart(),$.post(c.updateNoteRemarkUrl,{remark_rand_id:f.attr("data-rand-id"),version_id:f.attr("data-version-id"),content:e},function(b){if(b.loggedin===!1)window.location=c.loginComeFromUrl;else if(b.content&&b.version_id){h.content=b.content,h.version_id=b.version_id,f.attr("data-version-id",b.version_id),a.removeAttr("contentEditable").text(h.content);var d=f.children(".remark-footer");d.children().hide(),d.children(".remark-edit").show()}else b.version_error===!0?U("保存失败",'批注已在别处被更新，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试'):b.error&&U("保存失败",'出错啦，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试')},"json").fail(function(){U("保存失败",'出错啦，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试')})}}),k.on("click",".remark-reply > .remark-footer > .remark-save",function(){var a=$(this).parent(".remark-footer").siblings(".remark-editor"),b=$(this).siblings(".remark-delete"),e=X(a,d.maxRemarkReplyContentLength,b);if(null!==e){var f=$(this).parents(".remark-item"),g=$(this).parent(".remark-footer"),h=g.parent(".remark-reply");Pace.restart(),$.post(c.updateNoteRemarkReplyUrl,{remark_rand_id:f.attr("data-rand-id"),remark_reply_rand_id:h.attr("data-rand-id"),version_id:h.attr("data-version-id"),content:e},function(b){if(b.loggedin===!1)window.location=c.loginComeFromUrl;else if(b.content&&b.version_id){var d=Y(f),e=d.userNoteRemarkUI,i=e.userNoteRemarkReplyUIs[h.prevAll().length];i.content=b.content,i.version_id=b.version_id,h.attr("data-version-id",b.version_id),a.removeAttr("contentEditable").text(i.content),g.children().hide(),g.children(".remark-edit").show()}else b.version_error===!0?U("保存失败",'批注回复已在别处被更新，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试'):b.error&&U("保存失败",'出错啦，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试')},"json").fail(function(){U("保存失败",'出错啦，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试')})}});var bb=function(a,b){var d=Y(a),e=d.userNoteRemarkUI;b!==e.public&&(Pace.restart(),$.post(c.publishNoteRemarkUrl,{remark_rand_id:a.attr("data-rand-id"),version_id:a.attr("data-version-id"),is_public:b},function(b){if(b.loggedin===!1)window.location=c.loginComeFromUrl;else if(void 0!==b.is_public&&b.version_id){e.public=b.is_public,e.version_id=b.version_id,a.attr("data-version-id",b.version_id);var d=a.children(".remark-options");d.children("li:first").children(".icon-chevron-down").remove();var f=a.children(".remark-published-link").hide();b.is_public===!0?(d.prepend(d.children(".remark-public")),f.show(),f.css("right","95px"),f.tooltip({title:"点击更新地址栏以获取可分享此批注的链接",placement:"top"})):d.prepend(d.children(".remark-private")),d.children().hide(),d.children("li:first").append('<span class="icon-chevron-down"></span>').show()}else b.version_error===!0?U("保存失败",'批注已在别处被更新，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试'):b.error&&U("保存失败",'出错啦，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试')},"json").fail(function(){U("保存失败",'出错啦，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试')}))};k.on("click",".remark-item > .remark-options > .remark-public",function(){var a=$(this).parents(".remark-item");bb(a,!0)}),k.on("click",".remark-item > .remark-options > .remark-private",function(){var a=$(this).parents(".remark-item");bb(a,!1)}),k.on("click",".remark-item > .remark-published-link",function(){var b=$(this).parents(".remark-item"),c=z(),d=a();null===d?window.location.hash=c+"-"+b.attr("data-rand-id"):d.isFullReader&&(window.location.hash="full-reader-"+c+"-"+b.attr("data-rand-id"))}),k.on("click",".leave-reply span",function(){if(Z("添加新回复")){var a=$(this).parent(".leave-reply"),b=a.siblings(".new-reply"),c=l.clone().removeClass("side-remark-hidden").html();b.prepend(c),b.children(".remark-head").find("img").css("width","24px").css("height","24px"),a.hide(),b.show(),H(b)}}),k.on("click",".new-reply .remark-cancel",function(){var a=$(this).parents(".new-reply").html("").hide();a.siblings(".leave-reply").show()}),k.on("click",".new-reply .remark-save",function(){var a=$(this),b=a.siblings(".remark-cancel"),e=a.parent(".remark-footer"),f=e.siblings(".remark-editor"),g=X(f,d.maxRemarkReplyContentLength,b);if(null!==g){var h=a.parents(".remark-item"),i={remark_rand_id:h.attr("data-rand-id"),content:g};Pace.restart(),$.post(c.newNoteRemarkReplyUrl,i,function(a){if(a.loggedin===!1)window.location=c.loginComeFromUrl;else if(a.userNoteRemarkReplyUI){var d=JSON.parse(a.userNoteRemarkReplyUI),e=t.clone().removeClass("side-remark-hidden remark-item-reply").addClass("remark-reply");e.children(".remark-delete-link").remove(),v(e,d,!1),h.children(".remark-replies").append(e),b.trigger("click");var f=Y(h),g=f.userNoteRemarkUI,i=g.userNoteRemarkReplyUIs;i?i.push(d):(i=[d],g.userNoteRemarkReplyUIs=i)}else a.error},"json").fail(function(){})}}),k.on("click",".remark-reply-view-more",function(){var a=$(this),b=a.siblings(".remark-replies"),c=b.children(".remark-reply"),d=c.length;d===b.children(".remark-reply:visible").length?(c.each(function(a){d>3&&d-3>a&&$(this).hide()}),a.text("展开较早的 "+(d-3)+" 条回复")):(c.show(),a.text("收起较早的 "+(d-3)+" 条回复"))}),p.on("click",function(){Z("添加新批注")&&(p.hide(),n.show(),H(n))}),n.on("mouseenter",function(){if(b.highlightInfo){var a=f[b.highlightInfo.anchorId];b.highlight(a,b.highlightInfo.highlightStart,b.highlightInfo.highlightEnd)}else b.removeHighlight()}).on("mouseleave",function(){}),n.on("click",".remark-cancel",function(){k.children(".remark-item").length>0?(o.text(""),o.next(".inline-error").remove(),n.hide(),p.show()):(E(),b.removeHighlight())}),n.on("click",".remark-save",function(){var a=$(this),g=a.siblings(".remark-cancel"),h=X(o,d.maxRemarkContentLength,g);if(null!==h){var i=r.children(".remark-icon-clicked");if(0!==i.length){var j=i.attr("data-anchor-id"),l=f[j].textContent,m=null;m=a.hasClass("highlight-save")&&null!==b.highlightInfo?{content:h,anchor_id:b.highlightInfo.anchorId,anchor_content:l,highlight_content:b.highlightInfo.highlightContent,highlight_start:b.highlightInfo.highlightStart,highlight_end:b.highlightInfo.highlightEnd}:{content:h,anchor_id:j,anchor_content:l},Pace.restart(),$.post(c.newNoteRemarkUrl,m,function(d){if(d.loggedin===!1)window.location=c.loginComeFromUrl;else if(d.userNoteRemarkUI){var g=JSON.parse(d.userNoteRemarkUI),h=w(g);k.append(h),n.hide(),p.show(),o.text(""),a.removeClass("highlight-save"),b.highlightInfo=null;var j=e[g.anchor_id];j?j.push(g):(j=[g],e[g.anchor_id]=j);var l=f[g.anchor_id];1===i.length&&l&&(K=null,O(l,i,j))}else d.error},"json").fail(function(){})}}}),k.on("mouseenter",".remark-item .remark-options",function(){$(this).children().show()}).on("mouseleave",".remark-item .remark-options",function(){$(this).children().hide(),$(this).children("li:first").show()}),r.on("mouseenter",".remark-icon",function(){$(this).addClass("remark-icon-hover")}).on("mouseleave",".remark-icon",function(){$(this).removeClass("remark-icon-hover")}),k.on("mouseenter",".remark-reply",function(){$(this).children(".remark-delete-link").show()}).on("mouseleave",".remark-reply",function(){$(this).children(".remark-delete-link").hide()}),k.on("mouseup",".remark-item",function(a){var b=$(this);if(b.hasClass("remark-item-active")){var c=$(a.target);1===c.parents(".remark-footer").length||c.is(".remark-editor[contentEditable='true']")||1===c.parents(".remark-editor[contentEditable='true']").length||c.is(".leave-reply")||1===c.parents(".leave-reply").length?y(!1,$(this).prevAll().length,!0):y(!1,$(this).prevAll().length)}else k.children(".remark-item-active").removeClass("remark-item-active"),b.addClass("remark-item-active"),y(!1,$(this).prevAll().length)});var cb=!1;k.on("mouseenter",".remark-item",function(){var a=$(this);if(cb)return W.isFirefox&&setTimeout(function(){a.trigger("mouseenter")},500),!1;var b=r.children(".remark-icon-clicked"),c=b.attr("data-anchor-id");A(c,a.prevAll().length)}).on("mouseleave",".remark-item",function(){var a=$(this);if(cb)return W.isFirefox&&setTimeout(function(){a.trigger("mouseleave")},500),!1;if(b.removeHighlight(),$remarkItemActive=k.children(".remark-item-active"),1===$remarkItemActive.length){var c=r.children(".remark-icon-clicked"),d=c.attr("data-anchor-id");A(d,$remarkItemActive.prevAll().length)}});var db=function(a,d,e){var f=r.children(".remark-icon-clicked"),g=function(){if(a.addClass("remark-icon-clicked"),d===!0)c.loggedInUsername?B(!0,!0,e):B(!1,!0,null);else if(a.hasClass("remark-icon-empty")===!0)c.loggedInUsername?B(!0,!1,null):B(!1,!1,null);else{B(!1,!1,null);var b=a.attr("data-anchor-id");A(b,0)}};0===f.length?g():(b.removeHighlight(),a.attr("data-anchor-id")!==f.attr("data-anchor-id")?(C(),g()):(E(),a.hasClass("remark-icon-empty")===!0&&a.show()))};r.on("click",".remark-icon",function(){b.deselectTextAndHideToolbar();var c=$(this),d=a();d&&d.isEditorReader?com.zybuluo.mdeditor.mode.switchFullReaderMode(function(){c.hasClass("remark-icon-empty")===!0?M(c):L(),db(c,!1,null)}):V(function(){db(c,!1,null)})}),r.on("highlightClick",".remark-icon",function(a){var b=$(this);V(function(){db(b,!0,a.isRemarkOrHighlight)})});var eb=function(a,b){var c=r.children(".remark-icon");for(var d in c){var e=c[d];if(e.getAttribute("data-anchor-id")===a){var f=$(e);f.hasClass("remark-icon-empty")===!0?M(f):L(),f.trigger({type:"highlightClick",isRemarkOrHighlight:b});break}}},fb=function(b,c){var d=a();d&&d.isEditorReader?com.zybuluo.mdeditor.mode.switchFullReaderMode(function(){eb(b,c)}):eb(b,c)};return{relocateRemarkIcons:Q,relocateSideRemark:y,hideSideRemark:E,populateNoteRemarks:S,isPopulatedNoteRemarks:R,showSideRemarkByHighlight:fb}}();