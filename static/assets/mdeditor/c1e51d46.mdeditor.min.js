/*! zybuluo */
com.zybuluo.mdeditor.unifiedEditor = function() {
  function a() {
    window.lightMode || (e.renderer.setPadding(15), f[0].style.fontSize = "16px", f[0].style.lineHeight = "27px", f[0].style.fontFamily = 'Menlo, Ubuntu Mono, Consolas, "Courier New", Microsoft Yahei, Hiragino Sans GB, WenQuanYi Micro Hei, sans-serif')
  }

  function b(a, b) {
    var c = require("ace/config");
    c.loadModule("ace/ext/searchbox", function(c) {
      c.Search(a, b)
    }), $(".ace_search_form .ace_search_field").attr("placeholder", "查找"), $(".ace_replace_form .ace_search_field").attr("placeholder", "替换成");
    var d = $(".ace_replace_form .ace_replacebtn");
    $(d[0]).text("替换"), $(d[1]).text("所有");
    var e = $(".ace_search_options span");
    $(e[0]).attr("title", "按正则表达式查找"), $(e[1]).attr("title", "大小写敏感"), $(e[2]).attr("title", "查找完整单词")
  }

  function c() {
    e = ace.edit("wmd-input"), e.setOption("spellcheck", !0), e.setOption("scrollPastEnd", !0), e.renderer.setShowGutter(!1), e.renderer.setPrintMarginColumn(!1), e.session.setUseWrapMode(!0), e.session.setNewLineMode("unix"), e.setTheme("ace/theme/dawn");
    var c = require("ace/mode/markdown").Mode;
    return e.getSession().setMode(new c), e.session.$selectLongWords = !0, a(), e.setKeyboardHandler(""), e.commands.addCommands([{
      name: "Find",
      bindKey: {
        win: "Ctrl-F",
        mac: "Command-F"
      },
      exec: function(a) {
        b(a, !1)
      },
      readOnly: !0
    }, {
      name: "Replace",
      bindKey: {
        win: "Ctrl-Shift-F",
        mac: "Command-Option-F"
      },
      exec: function(a) {
        b(a, !0)
      },
      readOnly: !0
    }]), e
  }
  var d, e, f;
  if (window.lightMode){
    d = $("#wmd-input");
    f = d;
    d.tabHandler()
  }else {
    f = $("#wmd-input");
    var g = f.val();
    if ("" === g) {
      window.location.reload();
      return;
    };
    f.replaceWith('<div style="display:none" class="wmd-input theme" id="wmd-input"></div>');
    f = $("#wmd-input");
    e = c();
    e.setValue(g, -1);
    var h = e.getSession().getUndoManager();
    h.reset(), e.getSession().setUndoManager(h), f.css("display", "block")
  }
  var i = {
    setValue: function(a) {
      window.lightMode ? d.val(a) : e.setValue(a, -1)
    },
    getValue: function() {
      return window.lightMode ? d.val() : e.getValue()
    },
    focus: function() {
      window.lightMode ? d.focus() : e.focus()
    },
    getEditor: function() {
      return window.lightMode ? d : e
    },
    getWmdInput: function() {
      return f
    },
    restoreAceEditor: a,
    applyTheme: function(a) {
      window.lightMode || e.setTheme("theme-black" === a ? "ace/theme/tomorrow_night_eighties" : "ace/theme/dawn")
    },
    applyMode: function(a) {
      window.lightMode || (e.setKeyboardHandler("vim" === a ? "ace/keyboard/vim" : "emacs" === a ? "ace/keyboard/emacs" : ""), e.focus())
    },
    searchEditor: function(a) {
      window.lightMode || b(e, a)
    }
  };
  return i
}(), com.zybuluo.mdeditor.fileManager = function() {
  function a(a) {
    l().isEditorReader && (a ? ($("#preview-published-button").show(), $("#preview-publish-button").hide(), $("#preview-published-td").show(), $("#preview-publish-td").hide()) : ($("#preview-publish-button").show(), $("#preview-published-button").hide(), $("#preview-publish-td").show(), $("#preview-published-td").hide())), m.isPublic = a ? "True" : "False"
  }

  function b(b, c, d, e) {
    parentATag = $("ul#file-list span.whiter-on-black").parent("a"), c === !0 ? (parentATag.attr("title", "【已发布】 " + d), parentATag.find("i").removeClass().addClass("icon-share-sign"), a(c)) : (parentATag.attr("title", "【未发布】 " + d), parentATag.find("i").removeClass().addClass("icon-share"), a(c));
    var f = $(".article-updated-date");
    0 !== f.length && f.each(function() {
      $(this).html(d)
    }), m.currentId = String(b), m.currentVersionId = String(e)
  }

  function c(a) {
    var b = $("#file-list .whiter-on-black").first().parent("a").parent("li"),
      c = b.siblings(".tag-item"),
      d = [];
    $("#file-list .tag-item").each(function() {
      var c = $(this).attr("tag-name"),
        e = $(this).children(".tag-count"),
        f = $(this).parent("ul.tag-list"),
        g = f.find(".whiter-on-black"),
        h = 0 !== g.length;
      if (-1 !== a.indexOf(c)) {
        if (!h) {
          var i = null;
          $(this).nextAll().each(function() {
            return b.attr("file-created-date") > $(this).attr("file-created-date") ? (i = $(this), !1) : void 0
          }), null === i ? f.append(b.clone()) : i.before(b.clone()), e.text(Number(e.text()) + 1)
        }
        d.push(c)
      } else h && (1 === $(this).siblings().length ? $(this).parent("ul.tag-list").parent("li").remove() : (g.parent("a").parent("li").remove(), e.text(Number(e.text()) - 1)))
    });
    var e = function(a) {
        var b = null;
        return $("#file-list .tag-item").each(function() {
          return a < $(this).attr("tag-name") ? (b = $(this), !1) : void 0
        }), b
      },
      f = $("#file-list");
    for (var g in a) {
      var h = a[g];
      if (-1 === d.indexOf(h)) {
        var i = $('<li><ul class="tag-list"></ul></li>');
        i.find(".tag-list").append(c.clone()), i.find(".tag-name").text(h), i.find(".tag-count").text("1"), i.find(".tag-item").attr("tag-name", h).after(b.clone());
        var j = e(h);
        null === j ? f.append(i) : j.parent("ul").parent("li").before(i)
      }
    }
  }

  function d(a, b) {
    o(a, b, function() {
      window.location = m.loginComeFromUrl
    })
  }

  function e() {
    var a = "新建文稿",
      b = "【新建文稿】需要用户登录，现在登录？";
    return "True" !== m.isLoggedIn ? void d(a, b) : (b = "当前文稿内容已保存至云端，确认新建文稿？", void o(a, b, function() {
      $("#notification").find(".modal-body p").html("正在提交您的请求......"), $.post(m.newUserNoteUrl, {}, function(a) {
        a.loggedin === !1 ? ($("#notification").modal("hide"), window.location = m.loginComeFromUrl) : a.id && a.version_id ? ($("#notification").modal("hide"), window.location = a.newUrl) : a.error && $("#notification").find(".modal-body p").html('出错啦，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试')
      }, "json")
    }))
  }

  function f() {
    var a = "删除文稿",
      b = "【删除文稿】需要用户登录，现在登录？";
    if ("True" !== m.isLoggedIn) return void d(a, b);
    var c = $("ul#file-list span#" + m.currentId).text();
    b = "删除不可撤销，确认删除【<strong>" + c + "</strong>】？", o(a, b, function() {
      $("#notification").find(".modal-body p").html("正在提交您的请求......"), $.post(m.deleteUserNoteUrl, {
        id: m.currentId,
        version_id: m.currentVersionId
      }, function(a) {
        a.loggedin === !1 ? ($("#notification").modal("hide"), window.location = m.loginComeFromUrl) : a.userNoteUrl ? ($("#notification").modal("hide"), window.location = a.userNoteUrl) : a.version_error === !0 ? $("#notification").find(".modal-body p").html('文稿已在别处被更新，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试') : a.error && $("#notification").find(".modal-body p").html('出错啦，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试')
      }, "json")
    })
  }

  function g(a, b) {
    var c = "导出文稿",
      e = "【导出文稿】需要用户登录，现在登录？";
    if ("True" !== m.isLoggedIn) return void d(c, e);
    var f = $("ul#file-list span#" + m.currentId).text();
    if ( "markdown" === a ){
      n(b, f + ".markdown");
    } else if ( "html" == a ) {
      exports_html(function(err,body) {
        var g = '<!DOCTYPE html>\n<html>\n<head>\n<meta charset="utf-8">'+
        '<title>' 
        + f + 
        '</title></head><body>'+
          body+ 
        '</body></html>';
        n(g, f || 'no_title' + ".html");
      });
    }
  }
  function exports_html ( done ) {
    var svgs = $('#wmd-preview svg');
    var len = svgs.length;
    var data_urls = [];
    if( svgs.length ){
      svgs.each(function( idx, svg ) {
        svg_to_png_data_url(svg,
          function(err, data_url) {
            len --;
            data_urls.push(data_url);
            if( len == 0 ){
              finish();
            }
          })
      });
    } else {
      finish();
    }

    function finish (){
      var count = 0;
      done(
        null,
        $('#wmd-preview').html().replace(
            /\<svg.+<\/svg>/g,
            function() {
              return '<img src="' + data_urls[count++] + '"/>';
            }))
    } 
  }

  function h(a, c) {
    o(a, c, function() {
      $("#notification").find(".modal-body p").html("正在提交您的请求......");
      var a = $("#wmd-preview"),
        c = a.html(),
        d = com.zybuluo.mdeditor.common.caculatePreviewCharacters();
      $.post(m.publishUserNoteUrl, {
        id: m.currentId,
        version_id: m.currentVersionId,
        preview: c,
        is_public: !0,
        chars_count: d
      }, function(a) {
        if (a.loggedin === !1) $("#notification").modal("hide"), window.location = m.loginComeFromUrl;
        else if (a.id && a.version_id) {
          b(a.id, a.is_public, a.updated_date, a.version_id);
          var c = m.userNoteUrl;
          $("#notification").find(".modal-body p").html('发布成功！本文固定链接：<a href="' + c + '" target="_blank">' + c + "</a>，欢迎分享至社交网络"), $("#notification-cancel").hide(), $("#notification-confirm").data("operation", function() {
            $("#notification").modal("hide"), $("#notification-cancel").show()
          })
        } else a.version_error === !0 ? $("#notification").find(".modal-body p").html('文稿已在别处被更新，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试') : a.error && ("no preview" === a.error ? ($("#notification").find(".modal-body p").html("不能发布空白内容，请撰写内容后再发布"), $("#notification-confirm").data("operation", function() {
          $("#notification").modal("hide")
        })) : $("#notification").find(".modal-body p").html('出错啦，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试'))
      }, "json")
    })
  }

  function i() {
    var a = "发布文稿",
      b = "【发布文稿】需要用户登录，现在登录？";
    if ("True" !== m.isLoggedIn) return void d(a, b);
    var c = $("ul#file-list span#" + m.currentId).text();
    b = "发布文稿后您的稿件可以被他人访问分享，确认发布【<strong>" + c + "</strong>】？", h(a, b)
  }

  function j() {
    var a = "发布更新",
      b = "【发布更新】需要用户登录，现在登录？";
    if ("True" !== m.isLoggedIn) return void d(a, b);
    var c = $("ul#file-list span#" + m.currentId).text();
    b = "文稿发布后，如果您对稿件进行了修改更新，可以再次发布更新后的内容到固定链接，确认发布更新【<strong>" + c + "</strong>】？", h(a, b)
  }

  function k() {
    var a = "撤销发布",
      c = "【撤销发布】需要用户登录，现在登录？";
    if ("True" !== m.isLoggedIn) return void d(a, c);
    var e = $("ul#file-list span#" + m.currentId).text();
    c = "撤销发布后您的文稿只能被自己所见，确认撤销发布【<strong>" + e + "</strong>】？", o(a, c, function() {
      $("#notification").find(".modal-body p").html("正在提交您的请求......"), $.post(m.publishUserNoteUrl, {
        id: m.currentId,
        version_id: m.currentVersionId,
        preivew: null,
        is_public: !1
      }, function(a) {
        a.loggedin === !1 ? ($("#notification").modal("hide"), window.location = m.loginComeFromUrl) : a.id && a.version_id ? ($("#notification").modal("hide"), b(a.id, a.is_public, a.updated_date, a.version_id)) : a.version_error === !0 ? $("#notification").find(".modal-body p").html('文稿已在别处被更新，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试') : a.error && $("#notification").find(".modal-body p").html('出错啦，请 <a href="javascript:window.location.reload();void 0;">刷新</a> 页面后重试')
      }, "json")
    })
  }
  var l = com.zybuluo.mdeditor.common.getCurrentMode,
    m = com.zybuluo.mdeditor.initData,
    n = (com.zybuluo.common.pushState, com.zybuluo.mdeditor.common.saveAs),
    o = com.zybuluo.common.popupConfirm;
  return {
    switchPublishButton: a,
    reset_file_public_changes: b,
    reset_tag_changes: c,
    newFile: e,
    deleteFile: f,
    downloadFile: g,
    exports_html : exports_html,
    publishFile: i,
    republishFile: j,
    publishedFile: k
  }
}(), com.zybuluo.mdeditor.scrollLink = function() {
  var a, b = com.zybuluo.mdeditor.unifiedEditor,
    c = {
      extensionId: "scrollLink",
      extensionName: "Scroll Link",
      optional: !0,
      settingsBloc: ["<p>Binds together editor and preview scrollbars.</p>", '<blockquote class="muted"><b>NOTE:</b>', "   The mapping between Markdown and HTML is based on the position of the title elements (h1, h2, ...) in the page.", "   Therefore, if your document does not contain any title, the mapping will be linear and consequently less accurate.", "</bloquote>"].join("")
    },
    d = window.lightMode ? null : b.getEditor();
  c.onSectionsCreated = function(b) {
    a = b
  };
  var e = 0;
  c.onMarkdownTrim = function(a) {
    e = a
  };
  var f, g, h, i = [],
    j = [],
    k = -10,
    l = -10,
    m = _.debounce(function(b) {
      function c(a) {
        var b = r;
        if (void 0 !== a) {
          var c = document.createTextNode(a);
          g.empty().append(c), b += g.prop("scrollHeight")
        }
        var d = p + b;
        i.push({
          startOffset: p,
          endOffset: d,
          height: b,
          length: void 0 === a ? 0 : a.length + 1
        }), p = d
      }
      i = [];
      var m = 0,
        p = 0,
        q = e,
        r = 0;
      if (window.lightMode) {
        g.innerWidth(f.innerWidth()), _.each(a, function(b, d) {
          var e = b.text;
          d !== a.length - 1 ? 0 === e.length && (e = void 0) : /\n$/.test(e) && (e += "\n"), c(e)
        });
        var t = _.last(i).endOffset,
          u = f[0].scrollHeight,
          v = u / t;
        i = _.map(i, function(a) {
          return {
            startOffset: a.startOffset * v,
            endOffset: a.endOffset * v,
            height: a.height * v,
            length: a.length
          }
        })
      } else _.each(a, function(a) {
        m += a.text.length + q, q = 0;
        var b = d.session.doc.indexToPosition(m),
          c = d.session.documentToScreenPosition(b.row, b.column),
          e = c.row * d.renderer.lineHeight,
          f = e - p;
        i.push({
          startOffset: p,
          endOffset: e,
          height: f,
          length: void 0 === a.text ? 0 : a.text.length + 1
        }), p = e
      });
      j = [];
      var w, x = h.scrollTop();
      h.find("#wmd-preview > .md-section-divider").each(function() {
        if (void 0 === w) return void(w = 0);
        var a = $(this),
          b = a.position().top + x;
        j.push({
          startOffset: w,
          endOffset: b,
          height: b - w
        }), w = b
      });
      var y = h.prop("scrollHeight");
      j.push({
        startOffset: w,
        endOffset: y,
        height: y - w
      }), k = -10, l = -10, b === !0 ? n = !0 : b === !1 ? o = !0 : (null === b || void 0 === b) && (n = !0), s()
    }, 500),
    n = !1,
    o = !1,
    p = !1,
    q = !1,
    r = $("<div>"),
    s = _.throttle(function() {
      function a(a, b, c) {
        var d, e = _.find(b, function(b, c) {
          return d = c, a < b.endOffset
        });
        if (void 0 !== e) {
          var f = (a - e.startOffset) / (e.height || 1),
            g = c[d];
          return g.startOffset + g.height * f
        }
      }
      if (0 === i.length || i.length !== j.length) return void s();
      var b = window.lightMode ? f.scrollTop() : d.renderer.getScrollTop();
      0 > b && (b = 0);
      var c, e = h.scrollTop();
      if (n === !0) {
        if (Math.abs(b - k) <= 9) return;
        if (n = !1, k = b, c = a(b, i, j), c = _.min([c, h.prop("scrollHeight") - h.outerHeight()]), Math.abs(c - e) <= 9) return void(l = e);
        r.stop("scrollLinkFx", !0).css("value", 0).animate({
          value: c - e
        }, {
          duration: 200,
          queue: "scrollLinkFx",
          step: function(a) {
            q = !0, l = e + a, h.scrollTop(l)
          },
          done: function() {
            _.defer(function() {
              q = !1, v = !1
            })
          }
        }).dequeue("scrollLinkFx")
      } else if (o === !0) {
        if (Math.abs(e - l) <= 9) return;
        if (o = !1, l = e, c = a(e, j, i), window.lightMode ? c = _.min([c, f.prop("scrollHeight") - f.outerHeight()]) : (c = _.min([c, d.session.getScreenLength() * d.renderer.lineHeight + d.renderer.scrollMargin.bottom - d.renderer.$size.scrollerHeight]), 0 > c && (c = 0)), Math.abs(c - b) <= 9) return void(k = b);
        r.stop("scrollLinkFx", !0).css("value", 0).animate({
          value: c - b
        }, {
          duration: 200,
          queue: "scrollLinkFx",
          step: function(a) {
            p = !0, k = b + a, window.lightMode ? f.scrollTop(k) : d.session.setScrollTop(k)
          },
          done: function() {
            _.defer(function() {
              p = !1, v = !1
            })
          }
        }).dequeue("scrollLinkFx")
      }
    }, 100);
  c.buildSections = function() {
    m(!0)
  };
  var t = !1;
  c.onLayoutCreated = function() {
    h = $(".preview-container"), f = $("#wmd-input"), g = $("#md-section-helper"), h.scroll(function() {
      q === !1 && t === !1 && (o = !0, n = !1, s()), t = !1
    });
    var a = function() {
      p === !1 && (n = !0, o = !1, s())
    };
    window.lightMode ? f.scroll(a) : d.session.on("changeScrollTop", a)
  };
  var u;
  c.onEditorConfigure = function(a) {
    u = $("#wmd-preview"), a.getConverter().hooks.chain("postConversion", function(a) {
      return u.height(u.height()), a
    });
    var b = "^.+[ \\t]*\\n=+[ \\t]*\\n+|^.+[ \\t]*\\n-+[ \\t]*\\n+|^\\#{1,6}[ \\t]*.+?[ \\t]*\\#*\\n+";
    b = "^```.*\\n[\\s\\S]*?\\n```|" + b, b = "^[ \\t]*\\n\\$\\$[\\s\\S]*?\\$\\$|" + b, b = "^[ \\t]*\\n\\\\\\\\[[\\s\\S]*?\\\\\\\\]|" + b, b = "^[ \\t]*\\n\\\\?\\\\begin\\{[a-z]*\\*?\\}[\\s\\S]*?\\\\end\\{[a-z]*\\*?\\}|" + b, b = new RegExp(b, "gm");
    var d = a.getConverter();
    d.hooks.chain("preConversion", function(a) {
      function d(a, b) {
        var c = e.substring(g, b);
        f.push({
          text: c,
          textWithDelimiter: '\n<div class="md-section-divider"></div>\n\n' + c + "\n"
        })
      }
      var e = a + "\n\n",
        f = [],
        g = 0;
      return e.replace(b, function(a, b) {
        d(g, b), g = b
      }), d(g, a.length), c.onSectionsCreated(f), _.reduce(f, function(a, b) {
        return a + b.textWithDelimiter
      }, "")
    })
  };
  var v = !0;
  return c.onPreviewFinished = function() {
    var a = u.height();
    u.height("auto");
    var b = u.height();
    a > b && (t = !0), m(v === !0 ? !1 : !0)
  }, c.getCursorPositionForPageDownUpInFullEditorMode = function(a) {
    var b, c = _.find(i, function(c, d) {
      return b = d, a < c.endOffset
    });
    if (void 0 === c) return -1;
    for (var d = 0, e = 0; b >= e; e++) d += i[e].length;
    return d
  }, c
}(), com.zybuluo.mdeditor.mode = function() {
  function a() {
    if (f().isFullReader && 0 === $editorReaderFull.has("#wmd-preview").length) {
      $editorReaderFull.html("");
      var a = $("#reader-full-topInfo").clone().removeClass("reader-full-topInfo-hidden").addClass("reader-full-topInfo-shown");
      $editorReaderFull.append(a), $editorReaderFull.append($(".in-page-preview-buttons").addClass("in-page-preview-buttons-full-reader")), $editorReaderFull.append($("#wmd-preview").addClass("wmd-preview-full-reader").focus()), $editorReaderFull.append($(".remark-icons"))
    }
  }
  var b = com.zybuluo.mdeditor.unifiedEditor,
    c = com.zybuluo.mdeditor.sideRemark,
    d = com.zybuluo.mdeditor.scrollLink,
    e = (com.zybuluo.mdeditor.initData, com.zybuluo.mdeditor.common.buttonBinding),
    f = com.zybuluo.mdeditor.common.getCurrentMode,
    g = com.zybuluo.mdeditor.common.initialHiddenSideToolBar,
    h = com.zybuluo.mdeditor.common.colorWmdButtons,
    i = b.getWmdInput();
  $editorReaderFull = $("#editor-reader-full");
  var j = function() {
      $("#global-unverified-email-alert").alert("close"), c.hideSideRemark(), window.location.hash = "#full-editor", o(), $("#container").hide(), $editorReaderFull.removeClass("editor-reader-full-hidden").addClass("editor-reader-full-shown"), $("#wmd-editor-small-button").show(), $("#wmd-editor-full-button").hide(), window.lightMode && i.keydown(function(a) {
        var b = null,
          c = $(window).height() - $("#wmd-panel-editor").position().top,
          e = parseInt($(this).css("line-height"), 10);
        c -= 2 * e;
        var f = $("#wmd-panel-editor").scrollTop();
        if (33 === a.keyCode && (b = f - c), 34 === a.keyCode && (b = f + c), null !== b) {
          $("#wmd-panel-editor").animate({
            scrollTop: b
          }, 1);
          var g = d.getCursorPositionForPageDownUpInFullEditorMode(b);
          if (-1 != g) {
            var h = i.val().length;
            g > h && (g = h), i.setCursorPosition(g), a.preventDefault()
          }
        }
      }), h(), $editorReaderFull.append($("#wmd-button-bar").removeClass().addClass("wmd-button-bar-full-shown")), $editorReaderFull.append(window.lightMode ? $("#wmd-panel-editor").removeClass().addClass("wmd-panel-editor-full-shown") : $("#wmd-panel-editor").removeClass().addClass("wmd-panel-editor-full-shown-ace")), $("#wmd-panel-editor").prepend($(".in-page-editor-buttons")), n(), window.lightMode ? (i.css("max-width", "850px").focus(), $("#md-section-helper").attr("style", "max-width:850px; overflow:hidden; word-wrap:break-word; resize: none;")) : b.focus(), $(window).unbind("resize");
      var a = null;
      a = window.lightMode ? function() {
        i.autosize(), i.trigger("autosize.resize"), $("#wmd-panel-editor").height($(window).height() - $("#wmd-panel-editor").position().top), $(".in-page-editor-buttons").css("margin-left", i.position().left + i.width() - 125)
      } : function() {
        var a = $(window).width();
        i.width(a - 15);
        var c = a >= 850 ? (a - 850) / 2 : 0;
        b.getEditor().renderer.setPadding(c);
        var d = $(window).height() - $("#wmd-panel-editor").position().top;
        i.height(d), b.getEditor().resize(), $(".in-page-editor-buttons").css("margin-left", c + 850 - 125)
      }, $(window).resize(function() {
        a()
      }), $(window).resize()
    },
    k = function(a) {
      window.location.hash = "", window.lightMode && i.unbind("keydown"), h(), $("#wmd-button-bar").removeClass().addClass("wmd-button-bar"), $("#wmd-panel-editor").removeClass().addClass("wmd-panel-editor"), $("#editor-column").append($("#wmd-button-bar")), $("#editor-column").append($(".in-page-editor-buttons")), $("#editor-column").append($("#wmd-panel-editor")), n(), window.lightMode ? ($("#md-section-helper").removeAttr("style"), i.trigger("autosize.destroy"), i.removeAttr("style")) : (i.removeAttr("style"), b.restoreAceEditor(), b.getEditor().resize()), $("#wmd-panel-editor").removeAttr("style"), $("#wmd-editor-small-button").hide(), $("#wmd-editor-full-button").show(), $editorReaderFull.removeClass("editor-reader-full-shown").addClass("editor-reader-full-hidden"), $("#container").show(), a()
    },
    l = function(b) {
      $("#global-unverified-email-alert").alert("close"), com.zybuluo.mdeditor.common.caculateAndFillPreviewCharacters(), i.blur(), 0 !== window.location.hash.indexOf("#full-reader") && (window.location.hash = "#full-reader"), $("#container").hide(), $editorReaderFull.removeClass("editor-reader-full-hidden").addClass("editor-reader-full-shown"), $editorReaderFull.css("position", "static").css("padding-right", "75px"), $("#preview-reader-small-button").show(), $("#preview-reader-full-button").hide(), $("#preview-column li.editor-only").hide();
      var d = $("#preview-theme-button").removeClass("in-page-button").addClass("preview-button"),
        f = $("#preview-reader-full-button").removeClass("in-page-button").addClass("preview-button"),
        h = $("#preview-reader-small-button").removeClass("in-page-button").addClass("preview-button"),
        j = $("#preview-fullscreen-button").removeClass("in-page-button").addClass("preview-button");
      e(".preview-button > span", "#F9F9F5", "#BBBBBB"), 0 !== $("#preview-button-row #preview-list-button").length ? $("#preview-button-row #preview-list-button").after(j).after(h).after(f).after(d) : $("#preview-button-row").prepend(j).prepend(h).prepend(f).prepend(d), $("#reader-full-toolbar").removeClass("reader-full-toolbar-hidden").addClass("reader-full-toolbar-shown"), $("#reader-full-toolbar").append($("#preview-button-row").removeClass("pull-left pull-right")), $("#reader-full-toolbar-tail").removeClass("reader-full-toolbar-tail-hidden").addClass("reader-full-toolbar-tail-shown"), $("#file-list-topbar, #file-list, #about-menu").removeClass("pull-left pull-right").addClass("pull-right"), a(), $("#preview-button-row > li:visible").css("display", "block"), $("#preview-button-row > li:visible").removeClass("preview-button").addClass("preview-button-full-reader"), g.hideToolBarForMobile(), $(window).unbind("resize");
      var k = !1,
        l = _.debounce(function() {
          com.zybuluo.mdeditor.common.resetMaxHeightOfFileList(), c.relocateRemarkIcons(), c.relocateSideRemark(), k || (k = !0, b && "function" == typeof b && b())
        }, 200);
      $(window).resize(l), $(window).resize()
    },
    m = function(a) {
      c.hideSideRemark(), window.location.hash = "", g.isHidden() && g.hideToolBar(), $("#preview-button-row > li:visible").removeAttr("style"), $("#preview-button-row > li:visible").removeClass("preview-button-full-reader").addClass("preview-button"), $("#preview-button-row > li.wmd-spacer:visible").removeClass("preview-button"), $("#wmd-panel-preview").before($(".in-page-preview-buttons").removeClass("in-page-preview-buttons-full-reader")), $("#wmd-panel-preview").append($("#wmd-preview").removeClass("wmd-preview-full-reader")), $("#wmd-panel-preview").append($(".remark-icons"));
      var b = r.isExchanged(),
        d = "pull-right";
      b && (d = "pull-left"), $("#preview-button-bar").prepend($("#preview-button-row").addClass(d)), $("#file-list-topbar, #file-list, #about-menu").removeClass("pull-left pull-right").addClass(d), $("#reader-full-toolbar").removeClass("reader-full-toolbar-shown").addClass("reader-full-toolbar-hidden"), $("#reader-full-toolbar-tail").addClass("reader-full-toolbar-tail-hidden").addClass("reader-full-toolbar-tail-shown"), $("#preview-column li.editor-only").show();
      var e = $("#preview-theme-button").removeClass("preview-button").addClass("in-page-button"),
        f = $("#preview-reader-full-button").removeClass("preview-button").addClass("in-page-button"),
        h = $("#preview-reader-small-button").removeClass("preview-button").addClass("in-page-button"),
        i = $("#preview-fullscreen-button").removeClass("preview-button").addClass("in-page-button");
      n(), $(".in-page-preview-buttons > ul").append(e).append(f).append(h).append(i), $(".in-page-preview-buttons").removeClass("in-page-preview-buttons-full-reader"), $("#preview-reader-small-button").hide(), $("#preview-reader-full-button").show(), $editorReaderFull.html(""), $editorReaderFull.removeAttr("style"), $editorReaderFull.removeClass("editor-reader-full-shown").addClass("editor-reader-full-hidden"), $("#container").show(), a()
    },
    n = function() {
      $("body").hasClass("theme-black") ? e(".in-page-button > span", "rgba(249, 249, 245, 0.65)", "rgb(187, 187, 187, 0.45)") : e(".in-page-button > span", "rgba(44, 62, 80, 0.65)", "rgba(102, 128, 153, 0.45)")
    },
    o = function() {
      $("#article-loading-alert").hasClass("article-loading-alert-hidden") || ($("#article-loading-alert").removeAttr("style"), $("#article-loading-alert").addClass("article-loading-alert-hidden"))
    },
    p = function(a) {
      if (a && (f().isFullReader || f().isEditorReader)) {
        var b = 0;
        if (f().isEditorReader) {
          var c = $("#wmd-panel-preview");
          b = c.position().left + c.width() / 2 - 100
        } else b = $(window).width() / 2 - 150;
        var d = $(window).height() / 2 - 50;
        $("#article-loading-alert").removeClass("article-loading-alert-hidden").css("position", "fixed").css("z-index", 5e3).css("left", b + "px").css("top", d + "px")
      }
    },
    q = function() {
      var a = !1,
        b = function() {
          a ? ($("#wmd-button-bar").show(), $("#preview-button-bar").show(), a = !1) : ($("#wmd-button-bar").hide(), $("#preview-button-bar").hide(), a = !0)
        };
      return {
        hideToolBar: b,
        isHidden: function() {
          return a
        }
      }
    }(),
    r = function() {
      var a = !1,
        b = function() {
          a ? ($("#editor-column").removeClass("pull-right").addClass("pull-left"), $("#preview-column").removeClass("pull-left").addClass("pull-right"), $("#preview-button-row").removeClass("pull-left").addClass("pull-right"), $("ul.dropdown-menu.pull-left").removeClass("pull-left").addClass("pull-right"), $("#editor-reader-exchange-button span").removeClass("icon-chevron-sign-right").addClass("icon-chevron-sign-left"), a = !1) : ($("#editor-column").removeClass("pull-left").addClass("pull-right"), $("#preview-column").removeClass("pull-right").addClass("pull-left"), $("#preview-button-row").removeClass("pull-right").addClass("pull-left"), $("ul.dropdown-menu.pull-right").removeClass("pull-right").addClass("pull-left"), $("#editor-reader-exchange-button span").removeClass("icon-chevron-sign-left").addClass("icon-chevron-sign-right"), a = !0), $.localStorage("isEditorPreviewExchanged", a)
        },
        c = function() {
          var a = $.localStorage("isEditorPreviewExchanged");
          a || (a = !1), a && b()
        };
      return {
        exchange: b,
        loadDefault: c,
        isExchanged: function() {
          return a
        }
      }
    }();
  return {
    switchFullEditorMode: j,
    switchNormalModeFromFullEditorMode: k,
    fillUpFullReaderMode: a,
    switchFullReaderMode: l,
    switchNormalModeFromFullReaderMode: m,
    openArticleLoadingAlert: p,
    closeArticleLoadingAlert: o,
    initialHiddenTopToolBar: q,
    exchangeEditorPreview: r
  }
}(), com.zybuluo.mdeditor.init = function(a) {
  function b(a) {
    var b = !1;
    if (w.length !== a.length) b = !0;
    else
      for (var c in w)
        if (-1 === a.indexOf(w[c])) {
          b = !0;
          break
        }
    return b && (w = a, i.reset_tag_changes(w), A === !1 && (x === !1 ? (x = !0, $("#file-list-topbar").css("display", "block"), $("#file-list").css("display", "block"), $("#search-file-bar").css("display", "none"), $("#tag-file-bar").css("display", "block")) : clearTimeout(y), $("#file-list .tag-item:visible").hide(), $("#file-list .file-item:visible").hide(), $("#file-list .whiter-on-black").parent("a").parent("li").siblings(".tag-item").show(), y = setTimeout(function() {
      $("#file-list-topbar").css("display", ""), $("#file-list").css("display", ""), $("#search-file-bar").css("display", "block"), $("#tag-file-bar").css("display", "none"), x = !1
    }, 3e3))), b
  }

  function c(a) {
    var b, c, d, e, f = a.match(/^@@\s(.*)\s@@/),
      g = f[1].split(" "),
      h = g[0].match(/^-(\d+),(\d+)/);
    h ? (b = h[1], c = h[2]) : (b = g[0].match(/^-(\d+)/)[1], c = 1);
    var i = g[1].match(/^\+(\d+),(\d+)/);
    return i ? (d = i[1], e = i[2]) : (d = g[1].match(/^\+(\d+)/)[1], e = 1), [b, c, d, e]
  }

  function d(a) {
    for (var b = n(4); - 1 !== a.indexOf(b);) b = n(4);
    return a.push(b), b
  }

  function e() {
    if (null === F && null === G) {
      if (null !== j.anchorListString) {
        F = "" === j.anchorListString ? [] : j.anchorListString.split(" "), G = [];
        var a = 0;
        return q(function(b) {
          var c = F[a++];
          b.setAttribute("data-anchor-id", c), G.push(b.innerHTML)
        }), F
      }
      F = [], G = []
    }
    if (0 === F.length) return q(function(a) {
      var b = d(F);
      a.setAttribute("data-anchor-id", b), G.push(a.innerHTML)
    }), F;
    var b = [],
      e = q(function(a) {
        b.push(a.innerHTML)
      }),
      f = difflib.unifiedDiff(G, b);
    G = b, b = [];
    for (var g = [], h = 0, i = 2; i < f.length;) {
      var k = c(f[i]),
        l = k[0];
      for (k[1], k[2], k[3]; l - 1 > h; h++) g.push(F[h]);
      for (var m = -1, n = 0; ++i < f.length;) {
        var o = f[i][0];
        if (" " === o) n > 0 && (h += n, m = -1, n = 0), g.push(F[h]), h++;
        else if ("+" === o) {
          if (n > 0) {
            var p = new difflib.SequenceMatcher(null, f[m], f[i]);
            if (p.quickRatio() >= .33) {
              g.push(F[h]), h++, m++, n--, 0 === n && (m = -1);
              continue
            }
          }
          d(g)
        } else {
          if ("-" !== o) break; - 1 === m && (m = i), n++
        }
      }
      n > 0 && (h += n, m = -1, n = 0)
    }
    for (; h < F.length; h++) g.push(F[h]);
    if (F = g, e === F.length) {
      var r = 0;
      q(function(a) {
        a.setAttribute("data-anchor-id", F[r++])
      })
    }
    return F
  }

  function f(a, b, c, d) {
    H.attr("placeholder", d), H.val(""), $("#editorDialog").find("#editorDialog-title").text(a), $("#editorDialog").find(".modal-body p").text(b), $("#editorDialog").find(".modal-body i").removeClass().addClass(c), $("#editorDialog").modal({
      keyboard: !0
    })
  }
  var g = com.zybuluo.mdeditor.unifiedEditor,
    h = com.zybuluo.mdeditor.scrollLink,
    i = com.zybuluo.mdeditor.fileManager,
    j = com.zybuluo.mdeditor.initData,
    k = com.zybuluo.mdeditor.mode,
    l = com.zybuluo.mdeditor.common.applyPreviewElementTheme,
    m = com.zybuluo.common.popupConfirm,
    n = com.zybuluo.mdeditor.common.generateUUID,
    o = com.zybuluo.mdeditor.toc,
    p = com.zybuluo.mdeditor.sideRemark,
    q = com.zybuluo.mdeditor.common.wmdPreviewChildNodes_callback,
    r = "local-offline-note-" + j.currentId,
    s = Markdown.getSanitizingConverter();
  Markdown.Extra.init(s, {
    extensions: ["tables", "fenced_code_gfm", "def_list", "attr_list", "footnotes", "smartypants", "strikethrough", "newlines"],
    highlighter: "prettify"
  });
  var t, u = {
    strings: Markdown.local.zh
  };
  t = window.lightMode ? new Markdown.EditorLight(s, null, u) : new Markdown.Editor(s, null, u), h.onEditorConfigure(t), h.onLayoutCreated(), bindMathJaxHooks(s);
  var v = /((\n|^)(标签|tags)(.*?)(:|：)[^\S\n]*(\S*.*?)(\n|$))/i,
    w = [],
    x = !1,
    y = null,
    z = !1,
    A = !0,
    B = [];
  s.hooks.chain("preConversion", function(c) {
    if (a) {
      var d = [],
        e = function(a, b, c, e, f, g, h, i) {
          if (f.length > 10) return b;
          var j = "",
            k = h.trim().split(" ");
          for (var l in k) {
            var m = k[l].trim();
            if ("" !== m && (j = j + "`" + m + "` ", -1 === d.indexOf(m) && d.push(m), "4" === l)) break
          }
          return j = "" === j ? "` `" : j.substring(0, j.length - 1), c + j + i
        },
        f = c.replace(v, e);
      0 === d.length && (d = ["未分类"]);
      var g = b(d);
      return B = g === !0 || z === !0 ? d : [], f
    }
    return B = [], c
  });
  var C = function(b) {
      if ("True" == j.isEditablePage) {
        var c = null;
        a && (c = e().join(" "));
        var d = g.getValue(),
          f = $.localStorage("local-temp");
        if (d != f || A === !0) {
          $.localStorage("local-temp", d), $("#wmd-editor-save-button").show(), $("#wmd-editor-save-button > span").text(" 保存中...");
          var h = null;
          A === !0 ? (A = !1, h = {
            tags: JSON.stringify(b),
            anchor_list: c,
            id: j.currentId,
            version_id: j.currentVersionId
          }) : h = null !== c ? {
            details: d,
            tags: JSON.stringify(b),
            anchor_list: c,
            id: j.currentId,
            version_id: j.currentVersionId
          } : {
            details: d,
            tags: JSON.stringify(b),
            id: j.currentId,
            version_id: j.currentVersionId
          }, $.post(j.updateUserNoteUrl, h, function(b) {
            b.loggedin === !1 ? window.location = j.loginComeFromUrl : b.id && b.version_id ? (a ? (i.reset_file_public_changes(b.id, b.is_public, b.updated_date, b.version_id), $("ul#file-list span.whiter-on-black").text(b.title)) : (j.currentId = String(b.id), j.currentVersionId = String(b.version_id)), $.localStorage(r) && $.localStorage(r, null), z = !1, $("#wmd-editor-save-button > span").text("已保存"), $("#wmd-editor-save-button").delay(3e3).fadeOut()) : b.version_error === !0 && b.version_id ? (j.currentVersionId = String(b.version_id), $("#wmd-editor-save-button > span").html('<span class="red-on-black">保存失败</span>')) : b.error && $("#wmd-editor-save-button > span").html('<a class="red-on-black" href="javascript:window.location.reload();void 0;">保存失败</a>')
          }, "json").fail(function() {
            $("#wmd-editor-save-button > span").text("离线模式"), $.localStorage(r, d), z = !0
          })
        }
      } else "True" == j.isUrlMode ? ($("#wmd-editor-save-button").show(), $("#wmd-editor-save-button > span").text("只读模式")) : ($("#wmd-editor-save-button > span").text("登录后保存"), $("#wmd-editor-save-button").show().delay(3e3).fadeOut())
    },
    D = !0,
    E = $("#wmd-preview");
  t.hooks.chain("onPreviewRefresh", function() {
    function b() {
      ++c === d && (l(null), h.onPreviewFinished(), a && (k.fillUpFullReaderMode(), "True" === j.isEditablePage && p.populateNoteRemarks()), k.closeArticleLoadingAlert())
    }
    o.renderToc(), $(".prettyprint").each(function() {
      $(this).addClass("linenums")
    }), prettyPrint(), $('#wmd-preview a:not([href^="#"])').each(function() {
      $(this).attr("target", "_blank")
    }), D === !0 && (D = !1, h.onPreviewFinished()), C(B);
    var c = 0,
      d = 2;
    k.openArticleLoadingAlert(a), E.waitForImages(b), MathJax.Hub.Queue(["Typeset", MathJax.Hub, "wmd-preview"]), MathJax.Hub.Queue(b)
  });
  var F = null,
    G = null,
    H = $("#editorDialog").find(".modal-body input"),
    I = $("#editorDialog-confirm");
  H.on("keydown", function(a) {
    var b = a.charCode || a.keyCode;
    switch (b) {
      case 13:
        I.click()
    }
  }), t.hooks.set("insertLinkDialog", function(a) {
    return f("链接", "请输入链接地址", "icon-link icon-2x", 'http://example.com/ "可选标题"'), J = a, !0
  });
  var J = null;
  t.hooks.set("insertImageDialog", function(a) {
    return f("图片", "请输入图片地址", "icon-picture icon-2x", 'http://example.com/images/diagram.jpg "可选标题"'), J = a, !0
  }), $("#editorDialog").on("hidden", function() {
    if (J) {
      var a = I.data("url");
      a ? (I.removeData("url"), J(a)) : J(null)
    }
  }), I.click(function() {
    var a = H.val();
    a && $(this).data("url", a), $("#editorDialog").modal("hide")
  }), $("#editorDialog").on("shown", function() {
    H.focus()
  });
  var K = null,
    L = function(a) {
      var b = _.debounce(a, 500);
      return function() {
        null === K ? (a(), K = "") : b()
      }
    },
    M = g.getValue();
  if (window.lightMode ? (t.run(L), t.undoManager.reinit(M, 0, 0, 0)) : t.run(g.getEditor(), L), "True" == j.isEditablePage) {
    $.localStorage("local-temp", M);
    var N = $.localStorage(r);
    N && (N === M ? $.localStorage(r, null) : m("副本提醒", "在网络服务中断期间，我们在离线模式下为您保存了一份文稿【<strong>" + j.currentTitle + '</strong>】的本地副本，点击<strong>【确认】</strong>使用这份副本替换云端的版本，点击<strong>【取消】</strong>继续使用云端的版本<br><br><textarea style="width: 100%; height: 280px;" spellcheck="false" autocomplete="off">' + N + "</textarea>", function() {
      $("#notification").modal("hide"), g.setValue(N), t.refreshPreview(), $.localStorage(r, null)
    }, function() {
      $.localStorage(r, null)
    }))
  }
  return $("#wmd-bold-button > span").addClass("icon-bold muted"), $("#wmd-italic-button > span").addClass("icon-italic muted"), $("#wmd-link-button > span").addClass("icon-link muted"), $("#wmd-quote-button > span").addClass("icon-quote-left muted"), $("#wmd-code-button > span").addClass("icon-code muted"), $("#wmd-image-button > span").addClass("icon-picture muted"), $("#wmd-olist-button > span").addClass("icon-list-ol muted"), $("#wmd-ulist-button > span").addClass("icon-list-ul muted"), $("#wmd-heading-button > span").addClass("icon-list-alt muted"), $("#wmd-hr-button > span").addClass("icon-minus muted"), $("#wmd-undo-button > span").addClass("icon-reply muted"), $("#wmd-redo-button > span").addClass("icon-share-alt muted"), $("#wmd-bold-button").before('<li class="wmd-spacer"></li>'), $("#wmd-redo-button").after('<li id="wmd-editor-save-button" class="wmd-button" title="自动保存" style="width: 70px;"><span style="width: 70px; color: #777; font-size: 14px;"></span></li>'), $("#wmd-editor-save-button").css("margin-left", "50px"), $("#wmd-editor-small-button").hide(), $("#wmd-editor-save-button").hide(), t
}, $(function() {
  function a() {
    f.switchPublishButton("True" == g.isPublic), $(window).unbind("resize"), $(window).resize(z), $(window).resize(), c.focus()
  }

  function b() {
    y();
    var a = $(window).height() - $(".preview-container").position().top - 20;
    c.getWmdInput().height(a), window.lightMode || c.getEditor().resize(), $(".preview-container").height(a), $("#wmd-preview").height("auto"), $(".in-page-preview-buttons").css("margin-left", $("#preview-column").width() - 235), window.lightMode ? $(".in-page-editor-buttons").css("margin-left", $("#editor-column").width() - 170) : $(".in-page-editor-buttons").css("margin-left", $("#editor-column").width() - 200), m()
  }
  var c = com.zybuluo.mdeditor.unifiedEditor;
  com.zybuluo.mdeditor.init(!0);
  var d = com.zybuluo.mdeditor.common.getCurrentMode,
    e = com.zybuluo.mdeditor.scrollLink,
    f = com.zybuluo.mdeditor.fileManager,
    g = com.zybuluo.mdeditor.initData,
    h = com.zybuluo.mdeditor.mode,
    i = com.zybuluo.mdeditor.common.buttonBinding,
    j = com.zybuluo.mdeditor.common.initialHiddenSideToolBar,
    k = h.initialHiddenTopToolBar,
    l = h.exchangeEditorPreview,
    m = com.zybuluo.mdeditor.common.resetMaxHeightOfFileList,
    n = com.zybuluo.mdeditor.sideRemark;
  i(".wmd-button > span", "#F9F9F5", "#BBBBBB"), i(".preview-button > span", "#F9F9F5", "#BBBBBB"), $("a#signup, a#login").on("click", function() {
    window.location = $(this).attr("href")
  }), window.lightMode || $("#wmd-search-replace-button").on("click", function() {
    c.searchEditor(!0)
  }), $("#wmd-help-button").on("click", function() {
    window.open(g.markdownHelpUrl)
  });
  var o = function() {
    k.hideToolBar(), k.isHidden() ? ($("#wmd-hidden-menu-button span").removeClass("icon-chevron-sign-up").addClass("icon-chevron-sign-down"), $("#wmd-hidden-menu-button").attr("title", "显示工具栏")) : ($("#wmd-hidden-menu-button span").removeClass("icon-chevron-sign-down").addClass("icon-chevron-sign-up"), $("#wmd-hidden-menu-button").attr("title", "隐藏工具栏")), $(window).resize()
  };
  $("#wmd-hidden-menu-button").on("click", o), l.loadDefault(), $("#editor-reader-exchange-button").on("click", function() {
    l.exchange()
  }), $("#preview-info-button").on("show", function() {
    com.zybuluo.mdeditor.common.caculateAndFillPreviewCharacters()
  }), $("ul#file-list li a").on("click", function(a) {
    a.preventDefault();
    var b = $(this).attr("href");
    if ("-1" == g.currentId) window.location = b;
    else {
      var c = d();
      window.location = c.isEditorReader ? b : c.isFullReader ? b + "#full-reader" : b + window.location.hash
    }
  }), $("#preview-new-button").on("click", function() {
    f.newFile()
  }), $("#preview-delete-button").on("click", function() {
    f.deleteFile()
  }), $("#download-markdown-submenu").on("click", function() {
    f.downloadFile("markdown", c.getValue())
  }), $("#download-html-submenu").on("click", function() {
    f.downloadFile("html", null)
  }), $("#preview-publish-button").on("click", f.publishFile), $("#publish-updated-submenu").on("click", function(a) {
    a.preventDefault(), f.republishFile()
  }), $(".fixed-link-submenu").each(function() {
    $(this).on("click", function(a) {
      a.preventDefault(), window.open(g.userNoteUrl)
    })
  }), $("#revert-publish-submenu").on("click", function(a) {
    a.preventDefault(), f.publishedFile()
  }), f.switchPublishButton("True" == g.isPublic), com.zybuluo.mdeditor.common.loadSiteTheme(c);
  var p = com.zybuluo.mdeditor.common.switchSiteTheme;
  if ($("#preview-theme-button").on("click", function() {
      p(c)
    }), !window.lightMode) {
    var q = $("#mode-normal-submenu > span"),
      r = $("#mode-vim-submenu > span"),
      s = $("#mode-emacs-submenu > span"),
      t = function(a) {
        c.applyMode(a), q.removeClass("blue-on-black"), r.removeClass("blue-on-black"), s.removeClass("blue-on-black"), "vim" === a ? r.addClass("blue-on-black") : "emacs" === a ? s.addClass("blue-on-black") : q.addClass("blue-on-black"), $.localStorage("editorMode", a)
      };
    $("#mode-normal-submenu").on("click", function() {
      t("")
    }), $("#mode-vim-submenu").on("click", function() {
      t("vim")
    }), $("#mode-emacs-submenu").on("click", function() {
      t("emacs")
    });
    var u = $.localStorage("editorMode");
    u || (u = ""), t(u)
  }
  com.zybuluo.mdeditor.common.bindingFullScreenApi("#preview-fullscreen-button");
  var v = com.zybuluo.common.browserType,
    w = "keydown";
  (v.isOpera || v.isFirefox) && (w = "keypress"), $(document).on(w, function(b) {
    if ((b.ctrlKey || b.metaKey) && !b.shiftKey) {
      var e = d(),
        i = b.charCode || b.keyCode,
        k = String.fromCharCode(i).toLowerCase();
      switch (k) {
        case "s":
          break;
        case "m":
          if (b.altKey) {
            if (e.isEditorReader) {
              h.switchFullReaderMode();
              break
            }
            if (e.isFullReader) {
              h.switchNormalModeFromFullReaderMode(a);
              break
            }
            if (e.isFullEditor) {
              h.switchNormalModeFromFullEditorMode(a), h.switchFullReaderMode();
              break
            }
          } else {
            if (e.isEditorReader) {
              h.switchFullEditorMode();
              break
            }
            if (e.isFullEditor) {
              h.switchNormalModeFromFullEditorMode(a);
              break
            }
            if (e.isFullReader) {
              h.switchNormalModeFromFullReaderMode(a), h.switchFullEditorMode();
              break
            }
          }
          return;
        case "j":
          if (b.altKey) {
            p(c);
            break
          }
          return;
        case "h":
          if (b.altKey) {
            window.open(g.markdownHelpUrl);
            break
          }
          return;
        case "n":
          if (b.altKey && e.isEditorReader) {
            f.newFile();
            break
          }
          return;
        case "d":
          if (b.altKey && e.isEditorReader) {
            f.deleteFile();
            break
          }
          return;
        case "p":
          if (b.altKey && e.isEditorReader) {
            if ("True" == g.isPublic) {
              f.republishFile();
              break
            }
            f.publishFile();
            break
          }
          return;
        case "f":
          if (b.altKey && !e.isFullEditor) {
            $("#preview-list-button > span").dropdown("toggle");
            break
          }
          return;
        case "o":
          if (b.altKey && !e.isFullEditor) {
            $("#preview-toc-button > span").dropdown("toggle");
            break
          }
          return;
        case "i":
          if (b.altKey)
            if (e.isEditorReader) $("#preview-info-button > span").dropdown("toggle");
            else if (e.isFullReader) {
            j.hideToolBar();
            break
          }
          return;
        case "u":
          if (b.altKey && !e.isFullReader) {
            o();
            break
          }
          return;
        case "x":
          if (b.altKey && e.isEditorReader) {
            l.exchange();
            break
          }
          return;
        case "r":
          if (b.altKey && e.isEditorReader) {
            $("#preview-settings-button > span").dropdown("toggle");
            break
          }
          return;
        default:
          return
      }
      b.preventDefault && b.preventDefault(), window.event && (window.event.returnValue = !1)
    }
  });
  var x = com.zybuluo.mdeditor.mediumEditor,
    y = function() {
      d().isEditorReader && (x.deselectText(), x.hideToolbarActions())
    };
  $previewElt = $(".preview-container"), $previewElt.scroll(y);
  var z = function() {
    b(), e.buildSections(), n.relocateRemarkIcons()
  };
  $("#wmd-editor-full-button").on("click", h.switchFullEditorMode), $("#wmd-editor-small-button").on("click", function() {
    h.switchNormalModeFromFullEditorMode(a)
  }), $("#preview-reader-full-button").on("click", h.switchFullReaderMode), $("#preview-reader-small-button").on("click", function() {
    h.switchNormalModeFromFullReaderMode(a)
  }), $("#preview-reader-small-button").hide(), $(window).resize(z), b();
  var A = 0,
    B = c.getValue(),
    C = B.indexOf("\n");
  A = -1 != C ? C : B.length;
  var D = c.getEditor(),
    E = function() {
      window.lightMode ? D.setCursorPosition(A) : (-1 != C ? D.navigateLineEnd() : D.navigateFileEnd(), D.focus())
    },
    F = d();
  F.isFullEditor ? (E(), h.switchFullEditorMode()) : F.isFullReader ? h.switchFullReaderMode() : F.isHashMode || E()
});